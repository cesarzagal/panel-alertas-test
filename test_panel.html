<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Alertas - FYXTRACK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<style>
    :root {
        --fyx-dark-blue: #1e3a5f;
        --fyx-medium-blue: #2d5a87;
        --fyx-light-blue: #4fc3f7;
        --fyx-cyan: #00bcd4;
        --fyx-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #4fc3f7 100%);
        --status-pending: #6c757d;
        --status-in-progress: #4fc3f7;
        --status-second-level: #9c27b0;
        --status-resolved: #28a745;
        --type-critical: #dc3545;
        --type-warning: #ffc107;
        --type-low: #4fc3f7;
        --type-success: #28a745;
    }

    body { 
        background: #f8f9fa; 
        min-height: 100vh; 
        padding: 2rem 0; 
        color: #333; 
    }

    .brand-header { 
        background: white; 
        border-radius: 16px; 
        padding: 1.5rem 2rem; 
        margin-bottom: 2rem; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.1);
    }

    .brand-title { 
        font-size: 2.5rem; 
        font-weight: 700; 
        background: linear-gradient(90deg, #1e3a5f, #2d5a87, #4fc3f7); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
    }

    .brand-subtitle { 
        color: var(--fyx-medium-blue); 
        font-size: 0.9rem; 
        letter-spacing: 2px; 
        text-transform: uppercase; 
    }

    .alert-panel { 
        background: white; 
        border-radius: 16px; 
        overflow: hidden; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 20px rgba(30, 58, 95, 0.1);
    }

    .panel-header { 
        background: var(--fyx-gradient); 
        color: white; 
        padding: 1.5rem 2rem; 
    }

    .panel-body { 
        padding: 1.5rem; 
        background: white; 
    }

    .alerts-grid { 
        display: grid; 
        grid-template-columns: repeat(6, 1fr); 
        gap: 1rem; 
    }

    @media (max-width: 1400px) { .alerts-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 992px) { .alerts-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .alerts-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .alerts-grid { grid-template-columns: 1fr; } }

    .custom-alert { 
        background: white; 
        border: 2px solid; 
        border-radius: 10px; 
        padding: 1rem; 
        display: flex; 
        flex-direction: column; 
        transition: all 0.3s ease; 
        cursor: pointer; 
        min-height: 220px; 
        position: relative; 
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(30, 58, 95, 0.08);
    }

    .custom-alert:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 8px 25px rgba(30, 58, 95, 0.15); 
    }

    .custom-alert .alert-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .custom-alert .alert-title { font-weight: 600; font-size: 0.8rem; color: #333; }
    .custom-alert .alert-message { font-size: 0.7rem; color: #666; flex-grow: 1; }
    .custom-alert .alert-time { font-size: 0.65rem; color: #888; }
    .custom-alert .alert-vehicle { font-size: 0.7rem; font-weight: 500; color: var(--fyx-dark-blue); }

    /* Alertas por tipo */
    .custom-alert-danger { border-color: var(--type-critical); }
    .custom-alert-danger .alert-icon { color: var(--type-critical); }
    .custom-alert-warning { border-color: var(--type-warning); }
    .custom-alert-warning .alert-icon { color: var(--type-warning); }
    .custom-alert-low { border-color: var(--type-low); }
    .custom-alert-low .alert-icon { color: var(--type-low); }
    .custom-alert-success { border-color: var(--type-success); }
    .custom-alert-success .alert-icon { color: var(--type-success); }

    /* Alertas cr√≠ticas destacadas */
    .custom-alert-danger { 
        background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); 
        border-width: 3px; 
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15);
        animation: pulse-critical 2s infinite; 
    }

    .custom-alert-danger::before { 
        content: ''; 
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        height: 4px; 
        background: linear-gradient(90deg, #dc3545, #ff6b6b, #dc3545); 
        background-size: 200% 100%; 
        animation: gradient-move 2s linear infinite; 
    }

    .custom-alert-danger .alert-icon { animation: shake 0.5s ease-in-out infinite; }

    @keyframes pulse-critical { 
        0%, 100% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15); } 
        50% { box-shadow: 0 4px 25px rgba(220, 53, 69, 0.3); } 
    }

    @keyframes gradient-move { 
        0% { background-position: 0% 50%; } 
        100% { background-position: 200% 50%; } 
    }

    @keyframes shake { 
        0%, 100% { transform: rotate(0deg); } 
        25% { transform: rotate(-5deg); } 
        75% { transform: rotate(5deg); } 
    }

    .priority-badge { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        background: var(--type-critical); 
        color: white; 
        font-size: 0.55rem; 
        padding: 2px 6px; 
        border-radius: 10px; 
        font-weight: 700; 
        animation: blink 1s infinite; 
    }

    @keyframes blink { 
        0%, 100% { opacity: 1; } 
        50% { opacity: 0.6; } 
    }

    /* Estados */
    .alert-status-badge { 
        display: inline-flex; 
        align-items: center; 
        gap: 4px; 
        font-size: 0.6rem; 
        font-weight: 600; 
        padding: 0.2rem 0.5rem; 
        border-radius: 20px; 
        margin-top: auto; 
        background: rgba(30, 58, 95, 0.05);
    }

    .status-pending { color: var(--status-pending); border: 1px solid var(--status-pending); }
    .status-in-progress { color: var(--status-in-progress); border: 1px solid var(--status-in-progress); }
    .status-second-level { color: var(--status-second-level); border: 1px solid var(--status-second-level); }
    .status-resolved { color: var(--status-resolved); border: 1px solid var(--status-resolved); }

    .status-pending::before, .status-in-progress::before, .status-second-level::before, .status-resolved::before { 
        content: ''; 
        width: 6px; 
        height: 6px; 
        border-radius: 50%; 
    }

    .status-pending::before { background: var(--status-pending); }
    .status-in-progress::before { background: var(--status-in-progress); animation: pulse-status 1.5s infinite; }
    .status-second-level::before { background: var(--status-second-level); animation: pulse-status 1s infinite; }
    .status-resolved::before { background: var(--status-resolved); }

    @keyframes pulse-status { 
        0%, 100% { opacity: 1; transform: scale(1); } 
        50% { opacity: 0.5; transform: scale(1.3); } 
    }

    .custom-alert.has-status-pending { border-left: 4px solid var(--status-pending); }
    .custom-alert.has-status-in-progress { border-left: 4px solid var(--status-in-progress); }
    .custom-alert.has-status-second-level { border-left: 4px solid var(--status-second-level); }
    .custom-alert.has-status-resolved { border-left: 4px solid var(--status-resolved); }

    /* Dashboard cards */
    .dashboard-card { 
        background: white; 
        border-radius: 16px; 
        padding: 1.5rem; 
        height: 100%; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.08);
    }

    .dashboard-card-title { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--fyx-dark-blue); 
        margin-bottom: 1rem; 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
    }

    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 1rem; 
    }

    .stat-item { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        text-align: center; 
        border-left: 4px solid;
        border-top: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        border-bottom: 1px solid #e9ecef;
        transition: transform 0.3s;
    }

    .stat-item:hover { transform: translateY(-3px); }

    .stat-item.critical { border-left-color: var(--type-critical); }
    .stat-item.warning { border-left-color: var(--type-warning); }
    .stat-item.low { border-left-color: var(--type-low); }
    .stat-item.success { border-left-color: var(--type-success); }

    .stat-number { font-size: 2rem; font-weight: 700; }
    .stat-number.critical { color: var(--type-critical); }
    .stat-number.warning { color: var(--type-warning); }
    .stat-number.low { color: var(--type-low); }
    .stat-number.success { color: var(--type-success); }
    .stat-label { font-size: 0.75rem; color: #666; }

    .chart-container { width: 100%; height: 200px; }

    /* Filtros */
    .filter-section { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        border: 1px solid var(--fyx-light-blue);
    }

    .filter-section-title { 
        font-size: 0.8rem; 
        font-weight: 600; 
        color: var(--fyx-dark-blue); 
        margin-bottom: 0.75rem; 
    }

    .type-filter-btn, .status-filter-btn { 
        border-radius: 20px; 
        padding: 0.35rem 0.75rem; 
        font-size: 0.75rem; 
        border: 2px solid; 
        background: white; 
        font-weight: 500; 
        transition: all 0.3s; 
    }

    .type-filter-btn.filter-all { border-color: var(--fyx-dark-blue); color: var(--fyx-dark-blue); }
    .type-filter-btn.filter-all.active { background: var(--fyx-dark-blue); color: white; }
    .type-filter-btn.filter-critical { border-color: var(--type-critical); color: var(--type-critical); }
    .type-filter-btn.filter-critical.active { background: var(--type-critical); color: white; }
    .type-filter-btn.filter-warning { border-color: var(--type-warning); color: var(--type-warning); }
    .type-filter-btn.filter-warning.active { background: var(--type-warning); color: #212529; }
    .type-filter-btn.filter-low { border-color: var(--type-low); color: var(--fyx-dark-blue); }
    .type-filter-btn.filter-low.active { background: var(--type-low); color: white; }
    .type-filter-btn.filter-success { border-color: var(--type-success); color: var(--type-success); }
    .type-filter-btn.filter-success.active { background: var(--type-success); color: white; }

    .status-filter-btn.filter-all-status { border-color: var(--fyx-dark-blue); color: var(--fyx-dark-blue); }
    .status-filter-btn.filter-all-status.active { background: var(--fyx-dark-blue); color: white; }
    .status-filter-btn.filter-pending { border-color: var(--status-pending); color: var(--status-pending); }
    .status-filter-btn.filter-pending.active { background: var(--status-pending); color: white; }
    .status-filter-btn.filter-in-progress { border-color: var(--status-in-progress); color: var(--fyx-dark-blue); }
    .status-filter-btn.filter-in-progress.active { background: var(--status-in-progress); color: white; }
    .status-filter-btn.filter-second-level { border-color: var(--status-second-level); color: var(--status-second-level); }
    .status-filter-btn.filter-second-level.active { background: var(--status-second-level); color: white; }
    .status-filter-btn.filter-resolved { border-color: var(--status-resolved); color: var(--status-resolved); }
    .status-filter-btn.filter-resolved.active { background: var(--status-resolved); color: white; }

    .type-filter-btn:hover, .status-filter-btn:hover { transform: scale(1.05); }

    /* Modal */
    .modal-alert-detail .modal-dialog { max-width: 95%; width: 1400px; }
    .modal-alert-detail .modal-content { 
        border: none; 
        border-radius: 16px; 
        background: white; 
        border: 2px solid var(--fyx-dark-blue);
        overflow: hidden;
    }
    .modal-alert-detail .modal-header { border-bottom: none; padding: 1.5rem 2rem; }
    .modal-alert-detail .modal-body { padding: 0; }
    .modal-alert-detail .modal-footer { 
        background: #f8f9fa; 
        border-top: 1px solid var(--fyx-light-blue); 
    }

    /*#alertMap { width: 100%; height: 500px; }*/

    .detail-panel { 
        height: 500px; 
        overflow-y: auto; 
        padding: 1.5rem; 
        background: #f8f9fa; 
        color: #333;
        border-left: 1px solid var(--fyx-light-blue);
    }

    .detail-item { 
        display: flex; 
        justify-content: space-between; 
        padding: 0.75rem 0; 
        border-bottom: 1px solid #e9ecef; 
    }

    .detail-label { color: #666; font-size: 0.85rem; }
    .detail-value { font-weight: 600; color: var(--fyx-dark-blue); }

    .status-selector { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }

    .status-selector-btn { 
        padding: 0.4rem 0.8rem; 
        border-radius: 20px; 
        font-size: 0.75rem; 
        font-weight: 600; 
        border: 2px solid; 
        background: white; 
        cursor: pointer; 
        transition: all 0.3s;
    }

    .status-selector-btn:hover { transform: scale(1.05); }

    .status-selector-btn.pending-btn { border-color: var(--status-pending); color: var(--status-pending); }
    .status-selector-btn.pending-btn.active { background: var(--status-pending); color: white; }
    .status-selector-btn.in-progress-btn { border-color: var(--status-in-progress); color: var(--fyx-dark-blue); }
    .status-selector-btn.in-progress-btn.active { background: var(--status-in-progress); color: white; }
    .status-selector-btn.second-level-btn { border-color: var(--status-second-level); color: var(--status-second-level); }
    .status-selector-btn.second-level-btn.active { background: var(--status-second-level); color: white; }
    .status-selector-btn.resolved-btn { border-color: var(--status-resolved); color: var(--status-resolved); }
    .status-selector-btn.resolved-btn.active { background: var(--status-resolved); color: white; }

    .management-panel { 
        background: white; 
        border-top: 2px solid var(--fyx-light-blue); 
        padding: 1.5rem; 
    }

    .management-form { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        border: 1px solid var(--fyx-light-blue);
    }

    .management-form .form-select, 
    .management-form .form-control { 
        background: white; 
        border: 1px solid var(--fyx-light-blue); 
        color: #333; 
    }

    .management-form .form-select:focus, 
    .management-form .form-control:focus { 
        border-color: var(--fyx-dark-blue); 
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.15); 
    }

    .timeline { position: relative; padding-left: 30px; max-height: 300px; overflow-y: auto; }
    .timeline::before { 
        content: ''; 
        position: absolute; 
        left: 10px; 
        top: 0; 
        bottom: 0; 
        width: 2px; 
        background: var(--fyx-light-blue); 
    }

    .timeline-item { position: relative; padding-bottom: 1.25rem; }
    .timeline-item::before { 
        content: ''; 
        position: absolute; 
        left: -24px; 
        top: 5px; 
        width: 12px; 
        height: 12px; 
        border-radius: 50%; 
        border: 2px solid white;
    }

    .timeline-item.pending::before { background: var(--status-pending); box-shadow: 0 0 0 2px var(--status-pending); }
    .timeline-item.in-progress::before { background: var(--status-in-progress); box-shadow: 0 0 0 2px var(--status-in-progress); }
    .timeline-item.second-level::before { background: var(--status-second-level); box-shadow: 0 0 0 2px var(--status-second-level); }
    .timeline-item.resolved::before { background: var(--status-resolved); box-shadow: 0 0 0 2px var(--status-resolved); }

    .timeline-content { 
        background: white; 
        padding: 1rem; 
        border-radius: 10px; 
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .timeline-user { font-weight: 600; color: var(--fyx-dark-blue); }
    .timeline-date { font-size: 0.75rem; color: #888; }
    .timeline-text { font-size: 0.85rem; color: #555; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1100; }

    .speed-indicator { 
        display: inline-flex; 
        align-items: center; 
        gap: 0.5rem; 
        padding: 0.5rem 1rem; 
        border-radius: 20px; 
        font-weight: 600; 
    }

    .speed-indicator.high { background: #ffe0e0; color: #dc3545; border: 1px solid var(--type-critical); }
    .speed-indicator.medium { background: #fff8e0; color: #856404; border: 1px solid var(--type-warning); }
    .speed-indicator.low { background: #e0ffe0; color: #28a745; border: 1px solid var(--type-success); }

    .btn-fyx { 
        background: var(--fyx-gradient); 
        border: none; 
        color: white; 
    }

    .btn-fyx:hover {
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        color: white;
    }

    .btn-outline-fyx { 
        border: 2px solid var(--fyx-dark-blue); 
        color: var(--fyx-dark-blue); 
        background: white; 
    }

    .btn-outline-fyx:hover { 
        background: var(--fyx-dark-blue); 
        color: white; 
    }

    .legend-section { 
        display: flex; 
        gap: 2rem; 
        flex-wrap: wrap; 
        background: #f8f9fa; 
        padding: 1rem; 
        border-radius: 8px;
        border: 1px solid var(--fyx-light-blue);
    }

    .legend-title { font-weight: 600; font-size: 0.8rem; color: var(--fyx-dark-blue); }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #555; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }

    .fade-in-up { animation: fadeInUp 0.5s ease forwards; }
    @keyframes fadeInUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Footer */
    .footer-fyx { color: var(--fyx-dark-blue); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--fyx-light-blue); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--fyx-dark-blue); }

    /*************************************************  MAPA ********************************************************/

    #alertMap { width:100%; height:100%; }

    /* CONTROLES */
    .controls{
        position:absolute;
        bottom:20px;
        left:20px;
        background:rgba(0,0,0,.75);
        padding:10px;
        border-radius:8px;
        display:flex;
        gap:6px;
        z-index:20;
    }
    .controls button{
        background:#00C2FF;
        border:none;
        color:#000;
        font-weight:600;
        padding:6px 10px;
        border-radius:4px;
        cursor:pointer;
    }
    .controls button.active{ background:#fff }

    /* PUNTOS */
    .marker-point{
        width:6px;
        height:6px;
        background:#9e9e9e;
        border-radius:50%;
        opacity:.8;
    }

    /* EVENTO */
    .marker-warning{
        width:30px;
        height:30px;
        background:#e53935;
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:0 0 12px rgba(229,57,53,.9);
        position: relative;
    }
    .marker-warning svg{
        width:18px;
        height:18px;
        fill:#fff;
    }
    /* ANILLO PULSANTE */
    .marker-warning::after{
        content:"";
        position:absolute;
        left:50%;
        top:50%;
        width:30px;
        height:30px;
        background:rgba(229,57,53,.5);
        border-radius:50%;
        transform:translate(-50%,-50%) scale(1);
        animation:warningPulse 2s ease-out infinite;
        z-index:1;
    }
    @keyframes warningPulse{
        0%{
            transform:translate(-50%,-50%) scale(1);
            opacity:.6;
        }
        70%{
            transform:translate(-50%,-50%) scale(2.5);
            opacity:0;
        }
        100%{
            opacity:0;
        }
    }

    /* VEH√çCULO */
    .marker-vehicle{
        min-width:30px;
        padding:4px 8px;
        border-radius:14px;
        font-size:11px;
        font-weight:bold;
        text-align:center;
        white-space:nowrap;
        transition:background .3s, box-shadow .3s;
    }
    .vehicle-slow{
        background:#4CAF50;
        color:#000;
        box-shadow:0 0 12px rgba(76,175,80,.9);
    }
    .vehicle-normal{
        background:#00E5FF;
        color:#000;
        box-shadow:0 0 15px rgba(0,229,255,.9);
    }
    .vehicle-fast{
        background:#e53935;
        color:#fff;
        box-shadow:0 0 18px rgba(229,57,53,.95);
    }
    /*****************************************/
    /* POPUP MEJORADO - VERSI√ìN MEDIA OSCURA */
    #event-popup {
        position: absolute;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        color: #2c3e50;
        padding: 0;
        border-radius: 14px;
        box-shadow: 
            0 20px 50px rgba(0, 0, 0, 0.12),
            0 8px 16px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 1);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        pointer-events: auto;
        display: none;
        z-index: 999;
        white-space: normal;
        min-width: 300px;
        max-width: 360px;
        border: 2px solid #3b82f6;
        overflow: visible;
    }

    /* ENCABEZADO DEL POPUP */
    #event-popup .popup-header {
        padding: 10px 18px;
        background: linear-gradient(90deg, #f0f7ff 0%, #f8fbff 100%);
        border-bottom: 1px solid #dbeafe;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 12px 12px 0 0;
    }

    #event-popup .popup-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: #1e40af;
        flex: 1;
        letter-spacing: 0.2px;
    }

    /* ICONO EN HEADER */
    #event-popup .popup-header i {
        font-size: 18px;
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* CONTENIDO DEL POPUP */
    #event-popup .popup-content {
        padding: 16px 18px;
    }

    #event-popup .popup-content p {
        margin: 0 0 10px 0;
        font-size: 13px;
        line-height: 1.6;
        color: #475569;
    }

    #event-popup .popup-content p:last-child {
        margin-bottom: 0;
    }

    #event-popup .popup-content .event-text {
        font-weight: 600;
        color: #1e293b;
        display: block;
    }

    #event-popup .popup-content .event-date {
        font-size: 12px;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        font-weight: 500;
    }

    /* ICONO EN LA FECHA */
    #event-popup .popup-content .event-date i {
        font-size: 14px;
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* FLECHA - LADO DERECHO (POR DEFECTO) */
    #event-popup::before {
        content: "";
        position: absolute;
        left: -12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-right: 10px solid #ffffff;
        filter: drop-shadow(-3px 0 2px rgba(0, 0, 0, 0.08));
    }

    /* BORDE FLECHA DERECHA */
    #event-popup::after {
        content: "";
        position: absolute;
        left: -14px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 11px solid transparent;
        border-bottom: 11px solid transparent;
        border-right: 11px solid #3b82f6;
        z-index: -1;
    }

    /* FLECHA - LADO IZQUIERDO */
    #event-popup.arrow-left::before {
        content: "";
        position: absolute;
        right: -12px;
        left: auto;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        border-left: 10px solid #ffffff;
        border-right: none;
        filter: drop-shadow(3px 0 2px rgba(0, 0, 0, 0.08));
    }

    /* BORDE FLECHA IZQUIERDA */
    #event-popup.arrow-left::after {
        content: "";
        position: absolute;
        right: -14px;
        left: auto;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 11px solid transparent;
        border-bottom: 11px solid transparent;
        border-left: 11px solid #3b82f6;
        border-right: none;
        z-index: -1;
    }

    /* ANIMACI√ìN DE ENTRADA */
    @keyframes popupSlideUp {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #event-popup.visible {
        display: block;
        animation: popupSlideUp 0.3s ease-out;
    }

    /* RESPONSIVE */
    @media (max-width: 480px) {
        #event-popup {
            min-width: 280px;
            max-width: 85vw;
        }

        #event-popup .popup-header,
        #event-popup .popup-content {
            padding: 14px 16px;
        }

        #event-popup .popup-header h3 {
            font-size: 14px;
        }
    }

    /* ANIMACI√ìN DE ENTRADA */
    @keyframes popupSlideUp {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #event-popup.visible {
        display: block;
        animation: popupSlideUp 0.3s ease-out;
    }

    /* RESPONSIVE */
    @media (max-width: 480px) {
        #event-popup {
            min-width: 280px;
            max-width: 85vw;
        }

        #event-popup .popup-header,
        #event-popup .popup-content {
            padding: 14px 16px;
        }

        #event-popup .popup-header h3 {
            font-size: 14px;
        }
    }

    /* ANIMACIONES */
    @keyframes bounceLow{
        from{opacity:0;transform:scale(.95)}
        to{opacity:1;transform:scale(1)}
    }
    @keyframes bounceMedium{
        0%{opacity:0;transform:scale(.9)}
        60%{opacity:1;transform:scale(1.05)}
        100%{transform:scale(1)}
    }
    @keyframes bounceHigh{
        0%{opacity:0;transform:scale(.85)}
        50%{opacity:1;transform:scale(1.15)}
        100%{transform:scale(1)}
    }
    .popup-low{animation:bounceLow .4s ease-out}
    .popup-medium{animation:bounceMedium .6s cubic-bezier(.34,1.56,.64,1)}
    .popup-high{animation:bounceHigh .8s cubic-bezier(.2,2,.4,1)}

/***********************************************************************************************************************/
</style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container-fluid px-4">
        <div class="brand-header text-center fade-in-up">
            <h1 class="brand-title mb-0"><i class="bi bi-broadcast-pin me-2"></i>FYXTRACK</h1>
            <p class="brand-subtitle mb-0">GPS Intelligence - Centro de Alertas</p>
        </div>
        <div class="row mb-4 g-4">
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up">
                    <div class="dashboard-card-title"><i class="bi bi-bar-chart-fill"></i>Alertas por Tipo</div>
                    <div class="stats-grid">
                        <div class="stat-item critical"><div class="stat-number critical" id="criticalCount">0</div><div class="stat-label">Cr√≠ticas</div></div>
                        <div class="stat-item warning"><div class="stat-number warning" id="warningCount">0</div><div class="stat-label">Advertencias</div></div>
                        <div class="stat-item low"><div class="stat-number low" id="lowCount">0</div><div class="stat-label">Baja Criticidad</div></div>
                        <div class="stat-item success"><div class="stat-number success" id="successCount">0</div><div class="stat-label">√âxito</div></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up"><div class="dashboard-card-title"><i class="bi bi-pie-chart-fill"></i>Distribuci√≥n por Tipo</div><div id="chartTypes" class="chart-container"></div></div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up"><div class="dashboard-card-title"><i class="bi bi-pie-chart-fill"></i>Distribuci√≥n por Estado</div><div id="chartStatus" class="chart-container"></div></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="alert-panel fade-in-up">
                    <div class="panel-header">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div><h2 class="mb-0"><i class="bi bi-bell me-2"></i>Alertas Activas</h2><span class="opacity-75 small">√öltima actualizaci√≥n: hace 2 minutos</span></div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm" onclick="addNewAlert()"><i class="bi bi-plus-lg me-1"></i>Nueva</button>
                                <button class="btn btn-outline-light btn-sm" onclick="clearAllAlerts()"><i class="bi bi-trash me-1"></i>Limpiar</button>
                                <button class="btn btn-outline-light btn-sm" onclick="refreshAlerts()"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3" style="border-bottom: 1px solid rgba(79,195,247,0.2);">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="filter-section">
                                    <div class="filter-section-title"><i class="bi bi-funnel me-1"></i>Filtrar por Tipo</div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn type-filter-btn filter-all active" onclick="filterByType('all', this)"><i class="bi bi-grid me-1"></i>Todos</button>
                                        <button class="btn type-filter-btn filter-critical" onclick="filterByType('danger', this)"><i class="bi bi-exclamation-triangle me-1"></i>Cr√≠ticas</button>
                                        <button class="btn type-filter-btn filter-warning" onclick="filterByType('warning', this)"><i class="bi bi-exclamation-circle me-1"></i>Advertencias</button>
                                        <button class="btn type-filter-btn filter-low" onclick="filterByType('low', this)"><i class="bi bi-info-circle me-1"></i>Baja Criticidad</button>
                                        <button class="btn type-filter-btn filter-success" onclick="filterByType('success', this)"><i class="bi bi-check-circle me-1"></i>√âxito</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="filter-section">
                                    <div class="filter-section-title"><i class="bi bi-clipboard-check me-1"></i>Filtrar por Estado</div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn status-filter-btn filter-all-status active" onclick="filterByStatus('all', this)"><i class="bi bi-grid me-1"></i>Todos</button>
                                        <button class="btn status-filter-btn filter-pending" onclick="filterByStatus('pending', this)"><i class="bi bi-clock me-1"></i>Pendiente</button>
                                        <button class="btn status-filter-btn filter-in-progress" onclick="filterByStatus('in-progress', this)"><i class="bi bi-arrow-repeat me-1"></i>En Desarrollo</button>
                                        <button class="btn status-filter-btn filter-second-level" onclick="filterByStatus('second-level', this)"><i class="bi bi-arrow-up-circle me-1"></i>2do Nivel</button>
                                        <button class="btn status-filter-btn filter-resolved" onclick="filterByStatus('resolved', this)"><i class="bi bi-check-circle me-1"></i>Resuelta</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3" style="border-bottom: 1px solid rgba(79,195,247,0.2);">
                        <div class="legend-section">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <span class="legend-title"><i class="bi bi-tag me-1"></i>Tipos:</span>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-critical)"></div>Cr√≠tica</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-warning)"></div>Advertencia</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-low)"></div>Baja Criticidad</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-success)"></div>√âxito</div>
                            </div>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <span class="legend-title"><i class="bi bi-flag me-1"></i>Estados:</span>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-pending)"></div>Pendiente</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-in-progress)"></div>En Desarrollo</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-second-level)"></div>2do Nivel</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-resolved)"></div>Resuelta</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body"><div class="alerts-grid" id="alertContainer"></div></div>
                    <div class="p-3 text-center" style="background:rgba(13,33,55,0.5);border-top:1px solid rgba(79,195,247,0.2);">
                        <button class="btn btn-outline-fyx btn-sm" onclick="loadMoreAlerts()"><i class="bi bi-arrow-down-circle me-2"></i>Cargar m√°s</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4"><div class="col-12 text-center" style="color:#8899a6;"><i class="bi bi-broadcast-pin me-1"></i><strong>FYXTRACK</strong> GPS Intelligence | Panel de Alertas v4.0</div></div>
    </div>

    <div class="modal fade modal-alert-detail" id="alertDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <div><h5 class="modal-title mb-1" id="modalAlertTitle"></h5><span class="badge" id="modalAlertBadge"></span><span class="badge ms-1" id="modalAlertStatusBadge"></span></div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-0">
                        <div class="col-lg-7">
                            <div id="alertMap"></div>
                            <div id="event-popup">
                                <div class="popup-header">
                                    <div class="icon"></div>
                                    <h3></h3>
                                </div>
                                <div class="popup-content">
                                    <p class="event-text"></p>
                                    <p class="event-date"></p>
                                </div>
                            </div>

                            <div class="controls">
                                <button id="play">‚ñ∂</button>
                                <button id="pause">‚è∏</button>
                                <button id="replay">üîÅ</button>
                                <button class="speed" data-speed="0.25">0.25x</button>                                            
                                <button class="speed active" data-speed="1">1x</button>
                                <button class="speed" data-speed="2">2x</button>
                            </div>
                    </div>
                        <div class="col-lg-5">
                            <div class="detail-panel">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-toggle-on me-2"></i>Cambiar Estado:</h6>
                                <div class="status-selector">
                                    <button class="status-selector-btn pending-btn" onclick="changeAlertStatus('pending')"><i class="bi bi-clock me-1"></i>Pendiente</button>
                                    <button class="status-selector-btn in-progress-btn" onclick="changeAlertStatus('in-progress')"><i class="bi bi-arrow-repeat me-1"></i>En Desarrollo</button>
                                    <button class="status-selector-btn second-level-btn" onclick="changeAlertStatus('second-level')"><i class="bi bi-arrow-up-circle me-1"></i>2do Nivel</button>
                                    <button class="status-selector-btn resolved-btn" onclick="changeAlertStatus('resolved')"><i class="bi bi-check-circle me-1"></i>Resuelta</button>
                                </div>
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-info-circle me-2"></i>Detalles</h6>
                                <div class="mb-3"><div class="speed-indicator high" id="speedIndicator"><i class="bi bi-speedometer2"></i><span id="speedValue">0 km/h</span></div></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-tag me-1"></i>Tipo</span><span class="detail-value" id="detailAlertType"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-truck me-1"></i>Veh√≠culo</span><span class="detail-value" id="detailVehicle"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-person me-1"></i>Conductor</span><span class="detail-value" id="detailDriver"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-geo-alt me-1"></i>Direcci√≥n</span><span class="detail-value" id="detailAddress"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-speedometer me-1"></i>Velocidad</span><span class="detail-value" id="detailSpeed"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-calendar me-1"></i>Fecha/Hora</span><span class="detail-value" id="detailDateTime"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="management-panel">
                        <div class="row">
                            <div class="col-lg-5">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-plus-circle me-2"></i>Nueva Gesti√≥n</h6>
                                <div class="management-form">
                                    <div class="mb-3"><select class="form-select form-select-sm" id="managementType"><option value="comment">Comentario</option><option value="contact">Contacto con Conductor</option><option value="escalate">Escalar a 2do Nivel</option><option value="resolve">Marcar como Resuelta</option></select></div>
                                    <div class="mb-3"><textarea class="form-control form-control-sm" id="managementDescription" rows="2" placeholder="Descripci√≥n..."></textarea></div>
                                    <button class="btn btn-fyx btn-sm w-100" onclick="addManagement()"><i class="bi bi-send me-1"></i>Registrar</button>
                                </div>
                            </div>
                            <div class="col-lg-7">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-clock-history me-2"></i>Historial</h6>
                                <div class="timeline" id="managementTimeline"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-fyx btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="changeAlertStatus('resolved')"><i class="bi bi-check-lg me-1"></i>Resolver</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>
	
	<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaW5zdGl0dXRvMyIsImEiOiJjaWhucW9zbDEwcDE1dDRsem8zaWZ6d2hwIn0.vJXdd3-ACXm-gTty0kpuGQ';
    let map = null, currentAlertData = null, chartTypes = null, chartStatus = null;

    const statusConfig = {
        'pending': { label: 'Pendiente', icon: 'clock', class: 'pending', color: '#6c757d' },
        'in-progress': { label: 'En Desarrollo', icon: 'arrow-repeat', class: 'in-progress', color: '#4fc3f7' },
        'second-level': { label: '2do Nivel', icon: 'arrow-up-circle', class: 'second-level', color: '#9c27b0' },
        'resolved': { label: 'Resuelta', icon: 'check-circle', class: 'resolved', color: '#28a745' }
    };

    const typeConfig = {
        'danger': { label: 'Cr√≠tica', icon: 'exclamation-triangle-fill', color: '#dc3545' },
        'warning': { label: 'Advertencia', icon: 'exclamation-circle-fill', color: '#ffc107' },
        'low': { label: 'Baja Criticidad', icon: 'info-circle-fill', color: '#4fc3f7' },
        'success': { label: '√âxito', icon: 'check-circle-fill', color: '#28a745' }
    };

    const alertsData = [
        { id: 1, type: 'danger', title: 'Exceso de Velocidad', message: 'Veh√≠culo super√≥ l√≠mite', vehicle: 'ABC-123', driver: 'Juan P√©rez', speed: 125, speedLimit: 80, lat: 19.4326, lng: -99.1332, address: 'Av. Reforma #456', time: 'Hace 5 min', date: '09/02/2026', hour: '14:35:22', status: 'pending', history: [{ user: 'Sistema', date: '14:35', text: 'Alerta detectada', type: 'pending', badge: 'Detectada' }] },
        { id: 2, type: 'warning', title: 'Zona No Autorizada', message: 'Ingreso a geocerca', vehicle: 'XYZ-789', driver: 'Carlos L√≥pez', speed: 45, speedLimit: 60, lat: 19.4520, lng: -99.1627, address: 'Col. Polanco', time: 'Hace 12 min', date: '09/02/2026', hour: '14:28:15', status: 'in-progress', history: [{ user: 'Sistema', date: '14:28', text: 'Alerta detectada', type: 'pending', badge: 'Detectada' }, { user: 'Mar√≠a', date: '14:30', text: 'Tomando gesti√≥n', type: 'in-progress', badge: 'En Desarrollo' }] },
        { id: 3, type: 'danger', title: 'Bot√≥n de P√°nico', message: 'Emergencia activada', vehicle: 'DEF-456', driver: 'Ana Mart√≠nez', speed: 0, speedLimit: 80, lat: 19.3910, lng: -99.1663, address: 'Coyoac√°n', time: 'Hace 3 min', date: '09/02/2026', hour: '14:37:45', status: 'second-level', history: [{ user: 'Sistema', date: '14:37', text: 'P√°nico activado', type: 'pending', badge: 'Emergencia' }, { user: 'Supervisor', date: '14:38', text: 'Escalado', type: 'second-level', badge: '2do Nivel' }] },
        { id: 4, type: 'low', title: 'Mantenimiento', message: 'Servicio en 500 km', vehicle: 'GHI-321', driver: 'Roberto D√≠az', speed: 65, speedLimit: 80, lat: 19.4284, lng: -99.2072, address: 'Santa Fe', time: 'Hace 1 hora', date: '09/02/2026', hour: '13:40:00', status: 'pending', history: [{ user: 'Sistema', date: '13:40', text: 'Mantenimiento programado', type: 'pending', badge: 'Info' }] },
        { id: 5, type: 'success', title: 'Entrega Completada', message: 'Paquete entregado', vehicle: 'JKL-654', driver: 'Laura Hern√°ndez', speed: 0, speedLimit: 60, lat: 19.3573, lng: -99.1637, address: 'Tlalpan', time: 'Hace 30 min', date: '09/02/2026', hour: '14:10:33', status: 'resolved', history: [{ user: 'Laura', date: '14:10', text: 'Entrega confirmada', type: 'resolved', badge: 'Completada' }] },
        { id: 6, type: 'warning', title: 'Combustible Bajo', message: 'Nivel menor al 20%', vehicle: 'MNO-987', driver: 'Miguel Torres', speed: 78, speedLimit: 80, lat: 19.4969, lng: -99.1269, address: 'GAM', time: 'Hace 20 min', date: '09/02/2026', hour: '14:20:18', status: 'in-progress', history: [{ user: 'Sistema', date: '14:20', text: 'Combustible bajo', type: 'pending', badge: 'Advertencia' }] },
        { id: 7, type: 'danger', title: 'Motor Encendido', message: 'Sin movimiento 30 min', vehicle: 'PQR-147', driver: 'Fernando Ruiz', speed: 0, speedLimit: 60, lat: 19.4058, lng: -99.0959, address: 'Iztapalapa', time: 'Hace 8 min', date: '09/02/2026', hour: '14:32:55', status: 'pending', history: [{ user: 'Sistema', date: '14:32', text: 'Ralent√≠ prolongado', type: 'pending', badge: 'Detectada' }] },
        { id: 8, type: 'low', title: 'Llegada a Destino', message: 'Punto de entrega', vehicle: 'STU-258', driver: 'Patricia Vega', speed: 0, speedLimit: 40, lat: 19.4320, lng: -99.1335, address: 'Centro', time: 'Hace 15 min', date: '09/02/2026', hour: '14:25:42', status: 'resolved', history: [{ user: 'Sistema', date: '14:25', text: 'Llegada confirmada', type: 'resolved', badge: 'Llegada' }] },
        { id: 9, type: 'warning', title: 'Desv√≠o de Ruta', message: 'Fuera de ruta', vehicle: 'VWX-369', driver: 'Ricardo Mora', speed: 55, speedLimit: 60, lat: 19.3622, lng: -99.1856, address: 'Coyoac√°n Sur', time: 'Hace 25 min', date: '09/02/2026', hour: '14:15:30', status: 'second-level', history: [{ user: 'Supervisor', date: '14:20', text: 'Escalando', type: 'second-level', badge: '2do Nivel' }] },
        { id: 10, type: 'success', title: 'Inicio de Jornada', message: 'Jornada iniciada', vehicle: 'YZA-741', driver: 'Sandra Jim√©nez', speed: 25, speedLimit: 40, lat: 19.4195, lng: -99.1525, address: 'Col. Roma', time: 'Hace 2 horas', date: '09/02/2026', hour: '12:40:00', status: 'resolved', history: [{ user: 'Sandra', date: '12:40', text: 'Check-in', type: 'resolved', badge: 'Iniciada' }] },
        { id: 11, type: 'danger', title: 'Frenado Brusco', message: 'Frenado de emergencia', vehicle: 'BCD-852', driver: 'Eduardo Castro', speed: 15, speedLimit: 80, lat: 19.4456, lng: -99.1478, address: 'Col. Ju√°rez', time: 'Hace 10 min', date: '09/02/2026', hour: '14:30:12', status: 'in-progress', history: [{ user: 'Ana', date: '14:32', text: 'Contactando', type: 'in-progress', badge: 'En Desarrollo' }] },
        { id: 12, type: 'low', title: 'Actualizaci√≥n GPS', message: 'GPS actualizado', vehicle: 'EFG-963', driver: 'Gabriela R√≠os', speed: 45, speedLimit: 60, lat: 19.3856, lng: -99.1789, address: 'San √Ångel', time: 'Hace 45 min', date: '09/02/2026', hour: '13:55:00', status: 'resolved', history: [{ user: 'Sistema', date: '13:55', text: 'GPS v2.5.1', type: 'resolved', badge: 'Actualizado' }] }
    ];

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        renderAlerts();
        updateAllCounts();
        initCharts();
    });

    // Renderizar alertas
    function renderAlerts() {
        const container = document.getElementById('alertContainer');
        container.innerHTML = alertsData.map((alert, index) => createAlertCard(alert, index)).join('');
    }

    // Crear tarjeta de alerta
    function createAlertCard(alert, index) {
        const status = statusConfig[alert.status];
        const type = typeConfig[alert.type];
        const isCritical = alert.type === 'danger';
        
        return `
            <div class="custom-alert custom-alert-${alert.type} has-status-${alert.status} fade-in-up" 
                 data-type="${alert.type}" 
                 data-status="${alert.status}" 
                 data-id="${alert.id}" 
                 style="animation-delay:${index * 0.03}s" 
                 onclick="openAlertDetail(${alert.id})">
                ${isCritical ? '<span class="priority-badge">URGENTE</span>' : ''}
                <div class="alert-icon"><i class="bi bi-${type.icon}"></i></div>
                <div class="alert-title">${alert.title}</div>
                <p class="alert-message">${alert.message}</p>
                <div class="alert-vehicle"><i class="bi bi-truck me-1"></i>${alert.vehicle}</div>
                <div class="alert-time"><i class="bi bi-clock me-1"></i>${alert.time}</div>
                <div class="alert-status-badge status-${status.class}">
                    <i class="bi bi-${status.icon}"></i> ${status.label}
                </div>
            </div>
        `;
    }

    // Actualizar contadores
    function updateAllCounts() {
        document.getElementById('criticalCount').textContent = alertsData.filter(a => a.type === 'danger').length;
        document.getElementById('warningCount').textContent = alertsData.filter(a => a.type === 'warning').length;
        document.getElementById('lowCount').textContent = alertsData.filter(a => a.type === 'low').length;
        document.getElementById('successCount').textContent = alertsData.filter(a => a.type === 'success').length;
        updateCharts();
    }

    // Inicializar gr√°ficos
    function initCharts() {
        am5.ready(function() {
            // Gr√°fico de Tipos
            let root1 = am5.Root.new("chartTypes");
            root1.setThemes([am5themes_Animated.new(root1)]);
            chartTypes = root1.container.children.push(am5percent.PieChart.new(root1, { innerRadius: am5.percent(50) }));
            let series1 = chartTypes.series.push(am5percent.PieSeries.new(root1, { 
                valueField: "value", 
                categoryField: "category", 
                fillField: "color" 
            }));
            series1.slices.template.setAll({ strokeWidth: 2, stroke: am5.color(0xffffff) });
            series1.labels.template.setAll({ fontSize: 10, fill: am5.color(0x1e3a5f) });
            series1.ticks.template.setAll({ stroke: am5.color(0x1e3a5f) });

            // Gr√°fico de Estados
            let root2 = am5.Root.new("chartStatus");
            root2.setThemes([am5themes_Animated.new(root2)]);
            chartStatus = root2.container.children.push(am5percent.PieChart.new(root2, { innerRadius: am5.percent(50) }));
            let series2 = chartStatus.series.push(am5percent.PieSeries.new(root2, { 
                valueField: "value", 
                categoryField: "category", 
                fillField: "color" 
            }));
            series2.slices.template.setAll({ strokeWidth: 2, stroke: am5.color(0xffffff) });
            series2.labels.template.setAll({ fontSize: 10, fill: am5.color(0x1e3a5f) });
            series2.ticks.template.setAll({ stroke: am5.color(0x1e3a5f) });

            updateCharts();
        });
    }

    // Actualizar gr√°ficos
    function updateCharts() {
        if (chartTypes) {
            const typesData = [
                { category: "Cr√≠ticas", value: alertsData.filter(a => a.type === 'danger').length, color: am5.color(0xdc3545) },
                { category: "Advertencias", value: alertsData.filter(a => a.type === 'warning').length, color: am5.color(0xffc107) },
                { category: "Baja Criticidad", value: alertsData.filter(a => a.type === 'low').length, color: am5.color(0x4fc3f7) },
                { category: "√âxito", value: alertsData.filter(a => a.type === 'success').length, color: am5.color(0x28a745) }
            ].filter(d => d.value > 0);
            chartTypes.series.getIndex(0).data.setAll(typesData);
        }

        if (chartStatus) {
            const statusData = [
                { category: "Pendiente", value: alertsData.filter(a => a.status === 'pending').length, color: am5.color(0x6c757d) },
                { category: "En Desarrollo", value: alertsData.filter(a => a.status === 'in-progress').length, color: am5.color(0x4fc3f7) },
                { category: "2do Nivel", value: alertsData.filter(a => a.status === 'second-level').length, color: am5.color(0x9c27b0) },
                { category: "Resuelta", value: alertsData.filter(a => a.status === 'resolved').length, color: am5.color(0x28a745) }
            ].filter(d => d.value > 0);
            chartStatus.series.getIndex(0).data.setAll(statusData);
        }
    }

    // Abrir detalle de alerta
    function openAlertDetail(id) {
        const alert = alertsData.find(a => a.id === id);
        if (!alert) return;
        
        currentAlertData = alert;
        const type = typeConfig[alert.type];
        const status = statusConfig[alert.status];

        // Header
        document.getElementById('modalHeader').style.background = `linear-gradient(135deg, ${type.color} 0%, ${type.color}99 100%)`;
        document.getElementById('modalAlertTitle').innerHTML = `<i class="bi bi-${type.icon} me-2"></i>${alert.title}`;
        
        // Badges
        const typeBadge = document.getElementById('modalAlertBadge');
        typeBadge.textContent = type.label;
        typeBadge.style.background = type.color;
        typeBadge.style.color = 'white';

        const statusBadge = document.getElementById('modalAlertStatusBadge');
        statusBadge.textContent = status.label;
        statusBadge.style.background = status.color;
        statusBadge.style.color = 'white';

        // Detalles
        document.getElementById('detailAlertType').textContent = type.label;
        document.getElementById('detailVehicle').textContent = alert.vehicle;
        document.getElementById('detailDriver').textContent = alert.driver;
        document.getElementById('detailAddress').textContent = alert.address;
        document.getElementById('detailSpeed').textContent = `${alert.speed} / ${alert.speedLimit} km/h`;
        document.getElementById('detailDateTime').textContent = `${alert.date} ${alert.hour}`;

        // Velocidad
        document.getElementById('speedValue').textContent = `${alert.speed} km/h`;
        const speedClass = alert.speed > alert.speedLimit ? 'high' : alert.speed > alert.speedLimit * 0.8 ? 'medium' : 'low';
        document.getElementById('speedIndicator').className = `speed-indicator ${speedClass}`;

        updateStatusButtons(alert.status);
        updateTimeline(alert.history);

        const modal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
        modal.show();

        document.getElementById('alertDetailModal').addEventListener('shown.bs.modal', function() {
            initMap(/*alert*/);
        }, { once: true });
    }

    // Inicializar mapa
    function initMap(/*alert*/) {
        //if (map) map.remove();
        
        map=new mapboxgl.Map({
            container:"alertMap",
            style:"mapbox://styles/mapbox/navigation-night-v1",
            center:[-71.175,-32.78],
            zoom:14
        });

        map.addControl(new mapboxgl.NavigationControl());


        map.resize();
        map.fitBounds(bounds,{padding:80});

        // Recalcular la posici√≥n del popup
        setTimeout(() => {
        updatePopupPosition();
        map.fitBounds(bounds,{padding:80});
        }, 200); // Esperar a que termine la animaci√≥n del modal
        
    }

    // Actualizar botones de estado
    function updateStatusButtons(current) {
        document.querySelectorAll('.status-selector-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.status-selector-btn.${current}-btn`);
        if (activeBtn) activeBtn.classList.add('active');
    }

    // Cambiar estado de alerta
    function changeAlertStatus(newStatus) {
        if (!currentAlertData) return;

        const oldStatus = currentAlertData.status;
        const status = statusConfig[newStatus];
        
        currentAlertData.status = newStatus;
        currentAlertData.history.unshift({
            user: 'Usuario',
            date: new Date().toLocaleTimeString().slice(0, 5),
            text: `Estado cambiado: ${statusConfig[oldStatus].label} ‚Üí ${status.label}`,
            type: newStatus,
            badge: status.label
        });

        // Actualizar UI del modal
        updateStatusButtons(newStatus);
        updateTimeline(currentAlertData.history);

        const statusBadge = document.getElementById('modalAlertStatusBadge');
        statusBadge.textContent = status.label;
        statusBadge.style.background = status.color;

        // Actualizar tarjeta en el grid
        const card = document.querySelector(`[data-id="${currentAlertData.id}"]`);
        if (card) {
            card.className = `custom-alert custom-alert-${currentAlertData.type} has-status-${newStatus} fade-in-up`;
            card.dataset.status = newStatus;
            const badge = card.querySelector('.alert-status-badge');
            badge.className = `alert-status-badge status-${status.class}`;
            badge.innerHTML = `<i class="bi bi-${status.icon}"></i> ${status.label}`;
        }

        updateAllCounts();
        showToast(`Estado cambiado a: ${status.label}`, 'success');

        if (newStatus === 'resolved') {
            setTimeout(function() {
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('alertDetailModal'));
                if (modalInstance) modalInstance.hide();
            }, 800);
        }
    }

    // Actualizar timeline
    function updateTimeline(history) {
        const timeline = document.getElementById('managementTimeline');
        
        if (!history || history.length === 0) {
            timeline.innerHTML = '<p class="text-center" style="color:#8899a6;">Sin gestiones registradas</p>';
            return;
        }

        timeline.innerHTML = history.map(function(h) {
            const statusColor = statusConfig[h.type] ? statusConfig[h.type].color : '#6c757d';
            return `
                <div class="timeline-item ${h.type}">
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="timeline-user">${h.user}</span>
                            <span class="timeline-date">${h.date}</span>
                        </div>
                        <p class="timeline-text mb-2">${h.text}</p>
                        <span class="badge" style="background:${statusColor};font-size:0.65rem;">${h.badge}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Agregar gesti√≥n
    function addManagement() {
        const type = document.getElementById('managementType').value;
        const desc = document.getElementById('managementDescription').value.trim();

        if (!desc) {
            showToast('Ingresa una descripci√≥n', 'warning');
            return;
        }

        const labels = {
            comment: 'Comentario',
            contact: 'Contacto',
            escalate: 'Escalada',
            resolve: 'Resuelta'
        };

        const types = {
            comment: 'pending',
            contact: 'in-progress',
            escalate: 'second-level',
            resolve: 'resolved'
        };

        currentAlertData.history.unshift({
            user: 'Usuario',
            date: new Date().toLocaleTimeString().slice(0, 5),
            text: desc,
            type: types[type],
            badge: labels[type]
        });

        if (type === 'escalate') {
            changeAlertStatus('second-level');
        } else if (type === 'resolve') {
            changeAlertStatus('resolved');
        } else {
            updateTimeline(currentAlertData.history);
        }

        document.getElementById('managementDescription').value = '';
        showToast('Gesti√≥n registrada', 'success');
    }

    // Filtrar por tipo
    function filterByType(type, btn) {
        document.querySelectorAll('.type-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.custom-alert').forEach(function(alert) {
            if (type === 'all' || alert.dataset.type === type) {
                alert.style.display = 'flex';
            } else {
                alert.style.display = 'none';
            }
        });
    }

    // Filtrar por estado
    function filterByStatus(status, btn) {
        document.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.custom-alert').forEach(function(alert) {
            if (status === 'all' || alert.dataset.status === status) {
                alert.style.display = 'flex';
            } else {
                alert.style.display = 'none';
            }
        });
    }

    // Agregar nueva alerta
    function addNewAlert() {
        const types = ['danger', 'warning', 'low', 'success'];
        const statuses = ['pending', 'in-progress', 'second-level'];
        const titles = {
            danger: ['Exceso de Velocidad', 'Bot√≥n de P√°nico', 'Frenado Brusco', 'Colisi√≥n Detectada'],
            warning: ['Zona No Autorizada', 'Combustible Bajo', 'Desv√≠o de Ruta', 'Bater√≠a Baja'],
            low: ['Mantenimiento', 'Llegada a Destino', 'Actualizaci√≥n GPS', 'Reporte Programado'],
            success: ['Entrega Completada', 'Inicio de Jornada', 'Check-in Realizado', 'Ruta Completada']
        };

        const type = types[Math.floor(Math.random() * types.length)];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const title = titles[type][Math.floor(Math.random() * titles[type].length)];

        const newAlert = {
            id: Date.now(),
            type: type,
            status: status,
            title: title,
            message: 'Alerta generada autom√°ticamente',
            vehicle: `VEH-${Math.floor(Math.random() * 999).toString().padStart(3, '0')}`,
            driver: 'Conductor Asignado',
            speed: Math.floor(Math.random() * 120),
            speedLimit: 80,
            lat: 19.43 + (Math.random() * 0.1 - 0.05),
            lng: -99.13 + (Math.random() * 0.1 - 0.05),
            address: 'CDMX, M√©xico',
            time: 'Ahora',
            date: new Date().toLocaleDateString(),
            hour: new Date().toLocaleTimeString(),
            history: [{
                user: 'Sistema',
                date: new Date().toLocaleTimeString().slice(0, 5),
                text: 'Alerta creada autom√°ticamente',
                type: 'pending',
                badge: 'Nueva'
            }]
        };

        alertsData.unshift(newAlert);
        renderAlerts();
        updateAllCounts();
        showToast('Nueva alerta agregada', 'info');
    }

    // Limpiar todas las alertas
    function clearAllAlerts() {
        if (!confirm('¬øEst√°s seguro de eliminar todas las alertas?')) return;
        
        alertsData.length = 0;
        renderAlerts();
        updateAllCounts();
        showToast('Todas las alertas eliminadas', 'warning');
    }

    // Refrescar alertas
    function refreshAlerts() {
        const container = document.getElementById('alertContainer');
        container.style.opacity = '0.5';
        
        setTimeout(function() {
            container.style.opacity = '1';
            showToast('Alertas actualizadas', 'success');
        }, 500);
    }

    // Cargar m√°s alertas
    function loadMoreAlerts() {
        for (let i = 0; i < 6; i++) {
            setTimeout(function() {
                addNewAlert();
            }, i * 100);
        }
    }

    // Mostrar toast
    function showToast(message, type) {
        const icons = {
            success: 'check-circle-fill',
            danger: 'exclamation-triangle-fill',
            warning: 'exclamation-circle-fill',
            info: 'info-circle-fill'
        };

        const colors = {
            success: '#28a745',
            danger: '#dc3545',
            warning: '#ffc107',
            info: '#4fc3f7'
        };

        const container = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();

        const toastHTML = `
            <div id="${toastId}" class="toast show" role="alert" style="background:white;border:2px solid ${colors[type]};border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.15);">
                <div class="toast-header" style="background:${colors[type]};color:${type === 'warning' ? '#212529' : 'white'};border-radius:10px 10px 0 0;">
                    <i class="bi bi-${icons[type]} me-2"></i>
                    <strong class="me-auto">Notificaci√≥n</strong>
                    <button type="button" class="btn-close ${type === 'warning' ? '' : 'btn-close-white'}" onclick="this.closest('.toast').remove()"></button>
                </div>
                <div class="toast-body" style="color:#333;">
                    ${message}
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', toastHTML);

        setTimeout(function() {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.style.transition = 'opacity 0.3s';
                toast.style.opacity = '0';
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }
        }, 3000);
    }

    /***********************************  MAPA  *********************************************************************/
    const BASE_SPEED=1.1;
let speedMultiplier=1;
let currentEventCoord=null;
let bounds;
let map = null; // ‚Üê Cambia de const a let
let mapInitialized = false; // ‚Üê Agregar bandera

const events={
    "4303385":{
        severity:"high",
        title:"Evento",
        text:"Exceso de Velocidad en Calle de 57Km/h",
        date:"2026-02-06 18:41",
        shown:false
    }
};

const routePoints=[
    {name:"4277088",coords:[-71.14924,-32.80857],speed:40},
    {name:"4279360",coords:[-71.153496,-32.803543],speed:23},
    {name:"4281242",coords:[-71.15745,-32.798893],speed:10},
    {name:"4283496",coords:[-71.16154,-32.794075],speed:8},
    {name:"4285538",coords:[-71.16623,-32.78965],speed:27},
    {name:"4287762",coords:[-71.1719,-32.785046],speed:49},
    {name:"4289676",coords:[-71.17825,-32.7798],speed:1},
    {name:"4291879",coords:[-71.184586,-32.774628],speed:21},
    {name:"4292939",coords:[-71.19054,-32.769806],speed:40},
    {name:"4292948",coords:[-71.19312,-32.76684],speed:52},
    {name:"4294959",coords:[-71.19361,-32.76431],speed:51},
    {name:"4297050",coords:[-71.1948,-32.757874],speed:50},
    {name:"4299310",coords:[-71.19595,-32.751637],speed:49},
    {name:"4301381",coords:[-71.19724,-32.745445],speed:53},
    {name:"4303385",coords:[-71.19824,-32.739998],speed:57}
];

const EVENT_POINT_ID="4303385";
const ARC_STEPS=30;

function arc(a,b,s=ARC_STEPS,h=0.0006){
    return Array.from({length:s+1},(_,i)=>{
        const t=i/s;
        return [a[0]+(b[0]-a[0])*t,a[1]+(b[1]-a[1])*t+Math.sin(Math.PI*t)*h];
    });
}

function build(points){
    let r=[];
    for(let i=0;i<points.length-1;i++) r=r.concat(arc(points[i].coords,points[i+1].coords));
    return r;
}

function updatePopupPosition(){
    if(!currentEventCoord) return;

    const popup=document.getElementById("event-popup");
    const mapContainer=document.getElementById("map_event");

    if(popup.style.display==="none") return;

    const p=map.project(currentEventCoord);
    const popupWidth=popup.offsetWidth;
    const popupHeight=popup.offsetHeight;
    const mapWidth=mapContainer.clientWidth;

    let offsetX;

    if(p.x + popupWidth + 25 < mapWidth){
        offsetX=29;
        popup.classList.remove("arrow-left");
        popup.classList.add("arrow-right");
    }
    else{
        offsetX=-popupWidth-29;
        popup.classList.remove("arrow-right");
        popup.classList.add("arrow-left");
    }

    popup.style.left=(p.x+offsetX)+"px";
    popup.style.top=(p.y-popupHeight/2)+"px";
}

function initializeMap(){
    if(mapInitialized) {
        // Si ya est√° inicializado, solo ajusta el tama√±o
        map.resize();
        map.fitBounds(bounds, {padding: 80});
        return;
    }

    map = new mapboxgl.Map({
        container:"alertMap",
        style:"mapbox://styles/mapbox/navigation-night-v1",
        center:[-71.175,-32.78],
        zoom:14
    });

    let fullRoute=[],index=0,paused=false,raf=null;

    map.on("load",()=>{
        fullRoute=build(routePoints);
        const eventIndex=routePoints.findIndex(p=>p.name===EVENT_POINT_ID);
        const slowStart=eventIndex*ARC_STEPS;
        const slowEnd=slowStart+ARC_STEPS;

        map.addSource("route",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:[]}}});
        map.addLayer({id:"route",type:"line",source:"route",paint:{"line-color":"#00E5FF","line-width":6,"line-opacity":.9}});

        routePoints.forEach(p=>{
            if(events[p.name]){
                const el=document.createElement("div");
                el.className="marker-warning";
                el.innerHTML=`<svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>`;
                new mapboxgl.Marker(el).setLngLat(p.coords).addTo(map);
            }
            else{
                const el=document.createElement("div");
                el.className="marker-point";
                new mapboxgl.Marker(el).setLngLat(p.coords).addTo(map);
            }
        });

        bounds=new mapboxgl.LngLatBounds();
        routePoints.forEach(p=>bounds.extend(p.coords));

        const vEl=document.createElement("div");
        vEl.className="marker-vehicle vehicle-normal";
        vEl.innerText="0 km/h";
        const vehicle=new mapboxgl.Marker(vEl).setLngLat(routePoints[0].coords).addTo(map);

        const popup=document.getElementById("event-popup");

        function updateVehicleSpeed(){
            const segment=Math.floor(index/ARC_STEPS);
            const pt=routePoints[segment];
            if(!pt) return;
            vEl.innerText=pt.speed+" km/h";
            vEl.classList.remove("vehicle-slow","vehicle-normal","vehicle-fast");
            if(pt.speed<40) vEl.classList.add("vehicle-slow");
            else if(pt.speed<56) vEl.classList.add("vehicle-normal");
            else vEl.classList.add("vehicle-fast");
        }

        function animate(){
            if(paused) return;
            if(index<fullRoute.length){
                const coord=fullRoute[Math.floor(index)];
                vehicle.setLngLat(coord);
                updateVehicleSpeed();
                
                updatePopupPosition();

                map.getSource("route").setData({
                    type:"Feature",
                    geometry:{type:"LineString",coordinates:fullRoute.slice(0,index)}
                });

                routePoints.forEach((pt,i)=>{
                    const evt=events[pt.name];
                    if(!evt||evt.shown) return;
                    if(index>=i*ARC_STEPS){
                        currentEventCoord=pt.coords;
                        const severityIcon=evt.severity==="high"?"‚ö†Ô∏è":evt.severity==="medium"?"‚ö°":"‚ÑπÔ∏è";
                        
                        const iconEl=popup.querySelector(".popup-header .icon");
                        iconEl.textContent=severityIcon;
                        iconEl.className=`icon ${evt.severity}`;
                        
                        const titleEl=popup.querySelector(".popup-header h3");
                        titleEl.textContent=evt.title;
                        
                        const textEl=popup.querySelector(".popup-content .event-text");
                        textEl.textContent=evt.text;
                        
                        const dateEl=popup.querySelector(".popup-content .event-date");
                        dateEl.textContent=evt.date;
                        
                        popup.className="popup-"+evt.severity+" arrow-right";
                        popup.style.display="block";
                        updatePopupPosition();
                        evt.shown=true;
                    }
                });

                index+=(index>=slowStart&&index<=slowEnd?0.4:BASE_SPEED)*speedMultiplier;
                raf=requestAnimationFrame(animate);
            } 
            else{
                vehicle.getElement().style.display="none";
            }
        }

        map.on("move", updatePopupPosition);
        map.on("moveend", updatePopupPosition);

        document.getElementById("play").onclick=()=>{paused=false;animate();}
        document.getElementById("pause").onclick=()=>{paused=true;cancelAnimationFrame(raf);}
        document.getElementById("replay").onclick=()=>{
            cancelAnimationFrame(raf);
            index=0;paused=false;
            Object.values(events).forEach(e=>e.shown=false);
            popup.style.display="none";
            currentEventCoord=null;
            map.getSource("route").setData({type:"Feature",geometry:{type:"LineString",coordinates:[]}});
            animate();
        };

        document.querySelectorAll(".speed").forEach(b=>{
            b.onclick=()=>{
                speedMultiplier=Number(b.dataset.speed);
                document.querySelectorAll(".speed").forEach(x=>x.classList.remove("active"));
                b.classList.add("active");
            };
        });

        // Ajustar bounds despu√©s de cargar
        map.fitBounds(bounds, {padding: 80});
        mapInitialized = true;
    });
}

// ========================================
// EVENTO BOOTSTRAP - AGREGAR ESTO
// ========================================
// Reemplaza 'tuModalID' con el ID real de tu modal
$('#alertMap').on('shown.bs.modal', function () {
    initializeMap();
});

// O si usas JavaScript vanilla:
/*
document.getElementById('tuModalID').addEventListener('shown.bs.modal', function () {
    initializeMap();
});
*/

window.addEventListener('resize', () => {
    if(map) {
        map.resize();
        if(bounds) {
            map.fitBounds(bounds, {padding: 80});
        }
        updatePopupPosition();
    }
});
    /*
    // Y cuando el mapa termina de renderizar
    map.on('render', updatePopupPosition);
    map.fitBounds(bounds,{padding:80});
    */
</script>
</body>
</html>