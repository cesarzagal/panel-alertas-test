<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Alertas - FYXTRACK</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<style>
    :root {
        --fyx-dark-blue: #1e3a5f;
        --fyx-medium-blue: #2d5a87;
        --fyx-light-blue: #4fc3f7;
        --fyx-cyan: #00bcd4;
        --fyx-gradient: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #4fc3f7 100%);
        --status-pending: #6c757d;
        --status-in-progress: #4fc3f7;
        --status-second-level: #9c27b0;
        --status-resolved: #28a745;
        --type-critical: #dc3545;
        --type-warning: #ffc107;
        --type-low: #4fc3f7;
        --type-success: #28a745;
    }

    body { 
        background: #f8f9fa; 
        min-height: 100vh; 
        padding: 2rem 0; 
        color: #333; 
    }

    .brand-header { 
        background: white; 
        border-radius: 16px; 
        padding: 1.5rem 2rem; 
        margin-bottom: 2rem; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.1);
    }

    .brand-title { 
        font-size: 2.5rem; 
        font-weight: 700; 
        background: linear-gradient(90deg, #1e3a5f, #2d5a87, #4fc3f7); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
    }

    .brand-subtitle { 
        color: var(--fyx-medium-blue); 
        font-size: 0.9rem; 
        letter-spacing: 2px; 
        text-transform: uppercase; 
    }

    .alert-panel { 
        background: white; 
        border-radius: 16px; 
        overflow: hidden; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 20px rgba(30, 58, 95, 0.1);
    }

    .panel-header { 
        background: var(--fyx-gradient); 
        color: white; 
        padding: 1.5rem 2rem; 
    }

    .panel-body { 
        padding: 1.5rem; 
        background: white; 
    }

    .alerts-grid { 
        display: grid; 
        grid-template-columns: repeat(6, 1fr); 
        gap: 1rem; 
    }

    @media (max-width: 1400px) { .alerts-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 992px) { .alerts-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .alerts-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .alerts-grid { grid-template-columns: 1fr; } }

    .custom-alert { 
        background: white; 
        border: 2px solid; 
        border-radius: 10px; 
        padding: 1rem; 
        display: flex; 
        flex-direction: column; 
        transition: all 0.3s ease; 
        cursor: pointer; 
        min-height: 220px; 
        position: relative; 
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(30, 58, 95, 0.08);
    }

    .custom-alert:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 8px 25px rgba(30, 58, 95, 0.15); 
    }

    .custom-alert .alert-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .custom-alert .alert-title { font-weight: 600; font-size: 0.8rem; color: #333; }
    .custom-alert .alert-message { font-size: 0.7rem; color: #666; flex-grow: 1; }
    .custom-alert .alert-time { font-size: 0.65rem; color: #888; }
    .custom-alert .alert-vehicle { font-size: 0.7rem; font-weight: 500; color: var(--fyx-dark-blue); }

    /* Alertas por tipo */
    .custom-alert-danger { border-color: var(--type-critical); }
    .custom-alert-danger .alert-icon { color: var(--type-critical); }
    .custom-alert-warning { border-color: var(--type-warning); }
    .custom-alert-warning .alert-icon { color: var(--type-warning); }
    .custom-alert-low { border-color: var(--type-low); }
    .custom-alert-low .alert-icon { color: var(--type-low); }
    .custom-alert-success { border-color: var(--type-success); }
    .custom-alert-success .alert-icon { color: var(--type-success); }

    /* Alertas críticas destacadas */
    .custom-alert-danger { 
        background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); 
        border-width: 3px; 
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15);
        animation: pulse-critical 2s infinite; 
    }

    .custom-alert-danger::before { 
        content: ''; 
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        height: 4px; 
        background: linear-gradient(90deg, #dc3545, #ff6b6b, #dc3545); 
        background-size: 200% 100%; 
        animation: gradient-move 2s linear infinite; 
    }

    .custom-alert-danger .alert-icon { animation: shake 0.5s ease-in-out infinite; }

    @keyframes pulse-critical { 
        0%, 100% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15); } 
        50% { box-shadow: 0 4px 25px rgba(220, 53, 69, 0.3); } 
    }

    @keyframes gradient-move { 
        0% { background-position: 0% 50%; } 
        100% { background-position: 200% 50%; } 
    }

    @keyframes shake { 
        0%, 100% { transform: rotate(0deg); } 
        25% { transform: rotate(-5deg); } 
        75% { transform: rotate(5deg); } 
    }

    .priority-badge { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        background: var(--type-critical); 
        color: white; 
        font-size: 0.55rem; 
        padding: 2px 6px; 
        border-radius: 10px; 
        font-weight: 700; 
        animation: blink 1s infinite; 
    }

    @keyframes blink { 
        0%, 100% { opacity: 1; } 
        50% { opacity: 0.6; } 
    }

    /* Estados */
    .alert-status-badge { 
        display: inline-flex; 
        align-items: center; 
        gap: 4px; 
        font-size: 0.6rem; 
        font-weight: 600; 
        padding: 0.2rem 0.5rem; 
        border-radius: 20px; 
        margin-top: auto; 
        background: rgba(30, 58, 95, 0.05);
    }

    .status-pending { color: var(--status-pending); border: 1px solid var(--status-pending); }
    .status-in-progress { color: var(--status-in-progress); border: 1px solid var(--status-in-progress); }
    .status-second-level { color: var(--status-second-level); border: 1px solid var(--status-second-level); }
    .status-resolved { color: var(--status-resolved); border: 1px solid var(--status-resolved); }

    .status-pending::before, .status-in-progress::before, .status-second-level::before, .status-resolved::before { 
        content: ''; 
        width: 6px; 
        height: 6px; 
        border-radius: 50%; 
    }

    .status-pending::before { background: var(--status-pending); }
    .status-in-progress::before { background: var(--status-in-progress); animation: pulse-status 1.5s infinite; }
    .status-second-level::before { background: var(--status-second-level); animation: pulse-status 1s infinite; }
    .status-resolved::before { background: var(--status-resolved); }

    @keyframes pulse-status { 
        0%, 100% { opacity: 1; transform: scale(1); } 
        50% { opacity: 0.5; transform: scale(1.3); } 
    }

    .custom-alert.has-status-pending { border-left: 4px solid var(--status-pending); }
    .custom-alert.has-status-in-progress { border-left: 4px solid var(--status-in-progress); }
    .custom-alert.has-status-second-level { border-left: 4px solid var(--status-second-level); }
    .custom-alert.has-status-resolved { border-left: 4px solid var(--status-resolved); }

    /* Dashboard cards */
    .dashboard-card { 
        background: white; 
        border-radius: 16px; 
        padding: 1.5rem; 
        height: 100%; 
        border: 2px solid var(--fyx-dark-blue);
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.08);
    }

    .dashboard-card-title { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--fyx-dark-blue); 
        margin-bottom: 1rem; 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
    }

    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 1rem; 
    }

    .stat-item { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        text-align: center; 
        border-left: 4px solid;
        border-top: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        border-bottom: 1px solid #e9ecef;
        transition: transform 0.3s;
    }

    .stat-item:hover { transform: translateY(-3px); }

    .stat-item.critical { border-left-color: var(--type-critical); }
    .stat-item.warning { border-left-color: var(--type-warning); }
    .stat-item.low { border-left-color: var(--type-low); }
    .stat-item.success { border-left-color: var(--type-success); }

    .stat-number { font-size: 2rem; font-weight: 700; }
    .stat-number.critical { color: var(--type-critical); }
    .stat-number.warning { color: var(--type-warning); }
    .stat-number.low { color: var(--type-low); }
    .stat-number.success { color: var(--type-success); }
    .stat-label { font-size: 0.75rem; color: #666; }

    .chart-container { width: 100%; height: 200px; }

    /* Filtros */
    .filter-section { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        border: 1px solid var(--fyx-light-blue);
    }

    .filter-section-title { 
        font-size: 0.8rem; 
        font-weight: 600; 
        color: var(--fyx-dark-blue); 
        margin-bottom: 0.75rem; 
    }

    .type-filter-btn, .status-filter-btn { 
        border-radius: 20px; 
        padding: 0.35rem 0.75rem; 
        font-size: 0.75rem; 
        border: 2px solid; 
        background: white; 
        font-weight: 500; 
        transition: all 0.3s; 
    }

    .type-filter-btn.filter-all { border-color: var(--fyx-dark-blue); color: var(--fyx-dark-blue); }
    .type-filter-btn.filter-all.active { background: var(--fyx-dark-blue); color: white; }
    .type-filter-btn.filter-critical { border-color: var(--type-critical); color: var(--type-critical); }
    .type-filter-btn.filter-critical.active { background: var(--type-critical); color: white; }
    .type-filter-btn.filter-warning { border-color: var(--type-warning); color: var(--type-warning); }
    .type-filter-btn.filter-warning.active { background: var(--type-warning); color: #212529; }
    .type-filter-btn.filter-low { border-color: var(--type-low); color: var(--fyx-dark-blue); }
    .type-filter-btn.filter-low.active { background: var(--type-low); color: white; }
    .type-filter-btn.filter-success { border-color: var(--type-success); color: var(--type-success); }
    .type-filter-btn.filter-success.active { background: var(--type-success); color: white; }

    .status-filter-btn.filter-all-status { border-color: var(--fyx-dark-blue); color: var(--fyx-dark-blue); }
    .status-filter-btn.filter-all-status.active { background: var(--fyx-dark-blue); color: white; }
    .status-filter-btn.filter-pending { border-color: var(--status-pending); color: var(--status-pending); }
    .status-filter-btn.filter-pending.active { background: var(--status-pending); color: white; }
    .status-filter-btn.filter-in-progress { border-color: var(--status-in-progress); color: var(--fyx-dark-blue); }
    .status-filter-btn.filter-in-progress.active { background: var(--status-in-progress); color: white; }
    .status-filter-btn.filter-second-level { border-color: var(--status-second-level); color: var(--status-second-level); }
    .status-filter-btn.filter-second-level.active { background: var(--status-second-level); color: white; }
    .status-filter-btn.filter-resolved { border-color: var(--status-resolved); color: var(--status-resolved); }
    .status-filter-btn.filter-resolved.active { background: var(--status-resolved); color: white; }

    .type-filter-btn:hover, .status-filter-btn:hover { transform: scale(1.05); }

    /* Modal */
    .modal-alert-detail .modal-dialog { max-width: 95%; width: 1400px; }
    .modal-alert-detail .modal-content { 
        border: none; 
        border-radius: 16px; 
        background: white; 
        border: 2px solid var(--fyx-dark-blue);
        overflow: hidden;
    }
    .modal-alert-detail .modal-header { border-bottom: none; padding: 1.5rem 2rem; }
    .modal-alert-detail .modal-body { padding: 0; }
    .modal-alert-detail .modal-footer { 
        background: #f8f9fa; 
        border-top: 1px solid var(--fyx-light-blue); 
    }

    #alertMap { width: 100%; height: 500px; }

    .detail-panel { 
        height: 500px; 
        overflow-y: auto; 
        padding: 1.5rem; 
        background: #f8f9fa; 
        color: #333;
        border-left: 1px solid var(--fyx-light-blue);
    }

    .detail-item { 
        display: flex; 
        justify-content: space-between; 
        padding: 0.75rem 0; 
        border-bottom: 1px solid #e9ecef; 
    }

    .detail-label { color: #666; font-size: 0.85rem; }
    .detail-value { font-weight: 600; color: var(--fyx-dark-blue); }

    .status-selector { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }

    .status-selector-btn { 
        padding: 0.4rem 0.8rem; 
        border-radius: 20px; 
        font-size: 0.75rem; 
        font-weight: 600; 
        border: 2px solid; 
        background: white; 
        cursor: pointer; 
        transition: all 0.3s;
    }

    .status-selector-btn:hover { transform: scale(1.05); }

    .status-selector-btn.pending-btn { border-color: var(--status-pending); color: var(--status-pending); }
    .status-selector-btn.pending-btn.active { background: var(--status-pending); color: white; }
    .status-selector-btn.in-progress-btn { border-color: var(--status-in-progress); color: var(--fyx-dark-blue); }
    .status-selector-btn.in-progress-btn.active { background: var(--status-in-progress); color: white; }
    .status-selector-btn.second-level-btn { border-color: var(--status-second-level); color: var(--status-second-level); }
    .status-selector-btn.second-level-btn.active { background: var(--status-second-level); color: white; }
    .status-selector-btn.resolved-btn { border-color: var(--status-resolved); color: var(--status-resolved); }
    .status-selector-btn.resolved-btn.active { background: var(--status-resolved); color: white; }

    .management-panel { 
        background: white; 
        border-top: 2px solid var(--fyx-light-blue); 
        padding: 1.5rem; 
    }

    .management-form { 
        background: #f8f9fa; 
        border-radius: 12px; 
        padding: 1rem; 
        border: 1px solid var(--fyx-light-blue);
    }

    .management-form .form-select, 
    .management-form .form-control { 
        background: white; 
        border: 1px solid var(--fyx-light-blue); 
        color: #333; 
    }

    .management-form .form-select:focus, 
    .management-form .form-control:focus { 
        border-color: var(--fyx-dark-blue); 
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.15); 
    }

    .timeline { position: relative; padding-left: 30px; max-height: 300px; overflow-y: auto; }
    .timeline::before { 
        content: ''; 
        position: absolute; 
        left: 10px; 
        top: 0; 
        bottom: 0; 
        width: 2px; 
        background: var(--fyx-light-blue); 
    }

    .timeline-item { position: relative; padding-bottom: 1.25rem; }
    .timeline-item::before { 
        content: ''; 
        position: absolute; 
        left: -24px; 
        top: 5px; 
        width: 12px; 
        height: 12px; 
        border-radius: 50%; 
        border: 2px solid white;
    }

    .timeline-item.pending::before { background: var(--status-pending); box-shadow: 0 0 0 2px var(--status-pending); }
    .timeline-item.in-progress::before { background: var(--status-in-progress); box-shadow: 0 0 0 2px var(--status-in-progress); }
    .timeline-item.second-level::before { background: var(--status-second-level); box-shadow: 0 0 0 2px var(--status-second-level); }
    .timeline-item.resolved::before { background: var(--status-resolved); box-shadow: 0 0 0 2px var(--status-resolved); }

    .timeline-content { 
        background: white; 
        padding: 1rem; 
        border-radius: 10px; 
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .timeline-user { font-weight: 600; color: var(--fyx-dark-blue); }
    .timeline-date { font-size: 0.75rem; color: #888; }
    .timeline-text { font-size: 0.85rem; color: #555; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1100; }

    .speed-indicator { 
        display: inline-flex; 
        align-items: center; 
        gap: 0.5rem; 
        padding: 0.5rem 1rem; 
        border-radius: 20px; 
        font-weight: 600; 
    }

    .speed-indicator.high { background: #ffe0e0; color: #dc3545; border: 1px solid var(--type-critical); }
    .speed-indicator.medium { background: #fff8e0; color: #856404; border: 1px solid var(--type-warning); }
    .speed-indicator.low { background: #e0ffe0; color: #28a745; border: 1px solid var(--type-success); }

    .btn-fyx { 
        background: var(--fyx-gradient); 
        border: none; 
        color: white; 
    }

    .btn-fyx:hover {
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        color: white;
    }

    .btn-outline-fyx { 
        border: 2px solid var(--fyx-dark-blue); 
        color: var(--fyx-dark-blue); 
        background: white; 
    }

    .btn-outline-fyx:hover { 
        background: var(--fyx-dark-blue); 
        color: white; 
    }

    .legend-section { 
        display: flex; 
        gap: 2rem; 
        flex-wrap: wrap; 
        background: #f8f9fa; 
        padding: 1rem; 
        border-radius: 8px;
        border: 1px solid var(--fyx-light-blue);
    }

    .legend-title { font-weight: 600; font-size: 0.8rem; color: var(--fyx-dark-blue); }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #555; }
    .legend-color { width: 12px; height: 12px; border-radius: 3px; }

    .fade-in-up { animation: fadeInUp 0.5s ease forwards; }
    @keyframes fadeInUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Footer */
    .footer-fyx { color: var(--fyx-dark-blue); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--fyx-light-blue); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--fyx-dark-blue); }

    /*********************************  TRAEYCTO  ****************************************/















    @keyframes ripple {
        0% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }

    @keyframes pulse-speed {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
    }

    @keyframes bounce-in {
        0% {
            opacity: 0;
            transform: scale(0.3) translateY(-100px) rotate(-45deg);
        }
        50% {
            opacity: 1;
            transform: scale(1.1) translateY(0) rotate(-45deg);
        }
        70% {
            transform: scale(0.9) translateY(-10px) rotate(-45deg);
        }
        100% {
            transform: scale(1) translateY(0) rotate(-45deg);
        }
    }

    @keyframes popup-bounce {
        0% {
            opacity: 0;
            transform: translateX(-20px) scale(0.8);
        }
        60% {
            opacity: 1;
            transform: translateX(0) scale(1.05);
        }
        80% {
            transform: scale(0.98);
        }
        100% {
            transform: scale(1);
        }
    }

    @keyframes shadow-pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 0.3;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.5;
        }
    }

    /* Marker final redondo con pulse */
.final-marker-wrapper {
    position: relative;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.final-marker-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5);
    border: 3px solid white;
    position: relative;
    z-index: 2;
    animation: marker-appear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.final-marker-circle i {
    font-size: 15px;
    color: white;
}

.final-marker-pulse {
    position: absolute;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: rgba(220, 53, 69, 0.4);
    animation: marker-pulse 2s ease-out infinite;
    z-index: 1;
}

@keyframes marker-appear {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    60% {
        transform: scale(1.1);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes marker-pulse {
    0% {
        transform: scale(1);
        opacity: 0.7;
    }
    50% {
        transform: scale(1.5);
        opacity: 0.3;
    }
    100% {
        transform: scale(2);
        opacity: 0;
    }
}

    /* Reemplaza el CSS de .marker-pin */
    .marker-pin {
        width: 40px;
        height: 40px;
        border-radius: 50% 50% 50% 0;
        background: #dc3545;
        position: absolute;
        top: 0;
        left: 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border: 3px solid white;
    }

    .marker-pin::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50% 50% 50% 0;
        background: inherit;
        opacity: 0.3;
        animation: shadow-pulse 2s ease-in-out infinite;
    }

    .marker-pin i {
        transform: rotate(45deg);
    }

    .marker-shadow {
        width: 25px;
        height: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        position: absolute;
        bottom: -45px;  /* CAMBIADO: de -40px a -45px */
        left: 50%;
        transform: translateX(-50%);
        filter: blur(3px);
    }

    /* Popup compacto estilo Uber */
    /* Popup compacto estilo Uber */
.mapboxgl-popup-content {
    padding: 0 !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25) !important;
    overflow: hidden !important;
    background: white !important;
}

.mapboxgl-popup-anchor-left .mapboxgl-popup-tip {
    border-right-color: white !important;
}

.uber-popup {
    width: auto;
}

.uber-popup.popup-bounce-in {
    animation: popup-bounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.uber-popup-compact {
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: white;
    min-width: 140px;
}

.popup-speed {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 700;
    color: #dc3545;
}

.popup-speed i {
    font-size: 18px;
}

.popup-time {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #666;
}

.popup-time i {
    font-size: 14px;
    color: #4fc3f7;
}

/* Controles de animación - VERSION COMPACTA */
#animationControls {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    padding: 8px 14px;
    border-radius: 40px;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
    display: flex;
    gap: 6px;
    align-items: center;
    z-index: 10;
    border: 2px solid #4fc3f7;
}

.control-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: #4fc3f7;
    transform: scale(1.1);
}

.control-btn:active {
    transform: scale(0.95);
}

.speed-controls {
    display: flex;
    gap: 4px;
    margin-left: 6px;
    padding-left: 6px;
    border-left: 2px solid rgba(255, 255, 255, 0.3);
}

.speed-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.speed-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: #4fc3f7;
}

.speed-btn.active {
    background: #4fc3f7;
    border-color: #4fc3f7;
    color: #1e3a5f;
}

.divider {
    width: 1.5px;
    height: 24px;
    background: rgba(255, 255, 255, 0.3);
    margin: 0 3px;
}


</style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container-fluid px-4">
        <div class="brand-header text-center fade-in-up">
            <h1 class="brand-title mb-0"><i class="bi bi-broadcast-pin me-2"></i>FYXTRACK</h1>
            <p class="brand-subtitle mb-0">GPS Intelligence - Centro de Alertas</p>
        </div>
        <div class="row mb-4 g-4">
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up">
                    <div class="dashboard-card-title"><i class="bi bi-bar-chart-fill"></i>Alertas por Tipo</div>
                    <div class="stats-grid">
                        <div class="stat-item critical"><div class="stat-number critical" id="criticalCount">0</div><div class="stat-label">Críticas</div></div>
                        <div class="stat-item warning"><div class="stat-number warning" id="warningCount">0</div><div class="stat-label">Advertencias</div></div>
                        <div class="stat-item low"><div class="stat-number low" id="lowCount">0</div><div class="stat-label">Baja Criticidad</div></div>
                        <div class="stat-item success"><div class="stat-number success" id="successCount">0</div><div class="stat-label">Éxito</div></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up"><div class="dashboard-card-title"><i class="bi bi-pie-chart-fill"></i>Distribución por Tipo</div><div id="chartTypes" class="chart-container"></div></div>
            </div>
            <div class="col-lg-4">
                <div class="dashboard-card fade-in-up"><div class="dashboard-card-title"><i class="bi bi-pie-chart-fill"></i>Distribución por Estado</div><div id="chartStatus" class="chart-container"></div></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="alert-panel fade-in-up">
                    <div class="panel-header">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div><h2 class="mb-0"><i class="bi bi-bell me-2"></i>Alertas Activas</h2><span class="opacity-75 small">Última actualización: hace 2 minutos</span></div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm" onclick="addNewAlert()"><i class="bi bi-plus-lg me-1"></i>Nueva</button>
                                <button class="btn btn-outline-light btn-sm" onclick="clearAllAlerts()"><i class="bi bi-trash me-1"></i>Limpiar</button>
                                <button class="btn btn-outline-light btn-sm" onclick="refreshAlerts()"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3" style="border-bottom: 1px solid rgba(79,195,247,0.2);">
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="filter-section">
                                    <div class="filter-section-title"><i class="bi bi-funnel me-1"></i>Filtrar por Tipo</div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn type-filter-btn filter-all active" onclick="filterByType('all', this)"><i class="bi bi-grid me-1"></i>Todos</button>
                                        <button class="btn type-filter-btn filter-critical" onclick="filterByType('danger', this)"><i class="bi bi-exclamation-triangle me-1"></i>Críticas</button>
                                        <button class="btn type-filter-btn filter-warning" onclick="filterByType('warning', this)"><i class="bi bi-exclamation-circle me-1"></i>Advertencias</button>
                                        <button class="btn type-filter-btn filter-low" onclick="filterByType('low', this)"><i class="bi bi-info-circle me-1"></i>Baja Criticidad</button>
                                        <button class="btn type-filter-btn filter-success" onclick="filterByType('success', this)"><i class="bi bi-check-circle me-1"></i>Éxito</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="filter-section">
                                    <div class="filter-section-title"><i class="bi bi-clipboard-check me-1"></i>Filtrar por Estado</div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn status-filter-btn filter-all-status active" onclick="filterByStatus('all', this)"><i class="bi bi-grid me-1"></i>Todos</button>
                                        <button class="btn status-filter-btn filter-pending" onclick="filterByStatus('pending', this)"><i class="bi bi-clock me-1"></i>Pendiente</button>
                                        <button class="btn status-filter-btn filter-in-progress" onclick="filterByStatus('in-progress', this)"><i class="bi bi-arrow-repeat me-1"></i>En Desarrollo</button>
                                        <button class="btn status-filter-btn filter-second-level" onclick="filterByStatus('second-level', this)"><i class="bi bi-arrow-up-circle me-1"></i>2do Nivel</button>
                                        <button class="btn status-filter-btn filter-resolved" onclick="filterByStatus('resolved', this)"><i class="bi bi-check-circle me-1"></i>Resuelta</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3" style="border-bottom: 1px solid rgba(79,195,247,0.2);">
                        <div class="legend-section">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <span class="legend-title"><i class="bi bi-tag me-1"></i>Tipos:</span>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-critical)"></div>Crítica</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-warning)"></div>Advertencia</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-low)"></div>Baja Criticidad</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--type-success)"></div>Éxito</div>
                            </div>
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <span class="legend-title"><i class="bi bi-flag me-1"></i>Estados:</span>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-pending)"></div>Pendiente</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-in-progress)"></div>En Desarrollo</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-second-level)"></div>2do Nivel</div>
                                <div class="legend-item"><div class="legend-color" style="background:var(--status-resolved)"></div>Resuelta</div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body"><div class="alerts-grid" id="alertContainer"></div></div>
                    <div class="p-3 text-center" style="background:rgba(13,33,55,0.5);border-top:1px solid rgba(79,195,247,0.2);">
                        <button class="btn btn-outline-fyx btn-sm" onclick="loadMoreAlerts()"><i class="bi bi-arrow-down-circle me-2"></i>Cargar más</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4"><div class="col-12 text-center" style="color:#8899a6;"><i class="bi bi-broadcast-pin me-1"></i><strong>FYXTRACK</strong> GPS Intelligence | Panel de Alertas v4.0</div></div>
    </div>

    <div class="modal fade modal-alert-detail" id="alertDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <div><h5 class="modal-title mb-1" id="modalAlertTitle"></h5><span class="badge" id="modalAlertBadge"></span><span class="badge ms-1" id="modalAlertStatusBadge"></span></div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-0">
                        <div class="col-lg-7" style="position: relative;">
                            <div id="alertMap"></div>
                            <!-- Controles de animación -->
                            <div id="animationControls">
                                <button id="playBtn" class="control-btn" onclick="animateTrajectory(currentAlertData)" title="Reproducir">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button id="pauseBtn" class="control-btn" onclick="pauseAnimation()" title="Pausar" style="display: none;">
                                    <i class="bi bi-pause-fill"></i>
                                </button>
                                <button class="control-btn" onclick="restartAnimation()" title="Reiniciar">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="control-btn" onclick="stopAnimation()" title="Detener">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                                
                                <div class="divider"></div>
                                
                                <div class="speed-controls">
                                    <button class="speed-btn" data-speed="0.5" onclick="setAnimationSpeed(0.5)">0.5x</button>
                                    <button class="speed-btn active" data-speed="1" onclick="setAnimationSpeed(1)">1x</button>
                                    <button class="speed-btn" data-speed="2" onclick="setAnimationSpeed(2)">2x</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <div class="detail-panel">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-toggle-on me-2"></i>Cambiar Estado:</h6>
                                <div class="status-selector">
                                    <button class="status-selector-btn pending-btn" onclick="changeAlertStatus('pending')"><i class="bi bi-clock me-1"></i>Pendiente</button>
                                    <button class="status-selector-btn in-progress-btn" onclick="changeAlertStatus('in-progress')"><i class="bi bi-arrow-repeat me-1"></i>En Desarrollo</button>
                                    <button class="status-selector-btn second-level-btn" onclick="changeAlertStatus('second-level')"><i class="bi bi-arrow-up-circle me-1"></i>2do Nivel</button>
                                    <button class="status-selector-btn resolved-btn" onclick="changeAlertStatus('resolved')"><i class="bi bi-check-circle me-1"></i>Resuelta</button>
                                </div>
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-info-circle me-2"></i>Detalles</h6>
                                <div class="mb-3"><div class="speed-indicator high" id="speedIndicator"><i class="bi bi-speedometer2"></i><span id="speedValue">0 km/h</span></div></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-tag me-1"></i>Tipo</span><span class="detail-value" id="detailAlertType"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-truck me-1"></i>Vehículo</span><span class="detail-value" id="detailVehicle"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-person me-1"></i>Conductor</span><span class="detail-value" id="detailDriver"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-geo-alt me-1"></i>Dirección</span><span class="detail-value" id="detailAddress"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-speedometer me-1"></i>Velocidad</span><span class="detail-value" id="detailSpeed"></span></div>
                                <div class="detail-item"><span class="detail-label"><i class="bi bi-calendar me-1"></i>Fecha/Hora</span><span class="detail-value" id="detailDateTime"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="management-panel">
                        <div class="row">
                            <div class="col-lg-5">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-plus-circle me-2"></i>Nueva Gestión</h6>
                                <div class="management-form">
                                    <div class="mb-3"><select class="form-select form-select-sm" id="managementType"><option value="comment">Comentario</option><option value="contact">Contacto con Conductor</option><option value="escalate">Escalar a 2do Nivel</option><option value="resolve">Marcar como Resuelta</option></select></div>
                                    <div class="mb-3"><textarea class="form-control form-control-sm" id="managementDescription" rows="2" placeholder="Descripción..."></textarea></div>
                                    <button class="btn btn-fyx btn-sm w-100" onclick="addManagement()"><i class="bi bi-send me-1"></i>Registrar</button>
                                </div>
                            </div>
                            <div class="col-lg-7">
                                <h6 class="fw-bold mb-3" style="color:var(--fyx-light-blue);"><i class="bi bi-clock-history me-2"></i>Historial</h6>
                                <div class="timeline" id="managementTimeline"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-fyx btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="changeAlertStatus('resolved')"><i class="bi bi-check-lg me-1"></i>Resolver</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>
	
	<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaW5zdGl0dXRvMyIsImEiOiJjaWhucW9zbDEwcDE1dDRsem8zaWZ6d2hwIn0.vJXdd3-ACXm-gTty0kpuGQ';
    let map = null, currentAlertData = null, chartTypes = null, chartStatus = null;

    const statusConfig = {
        'pending': { label: 'Pendiente', icon: 'clock', class: 'pending', color: '#6c757d' },
        'in-progress': { label: 'En Desarrollo', icon: 'arrow-repeat', class: 'in-progress', color: '#4fc3f7' },
        'second-level': { label: '2do Nivel', icon: 'arrow-up-circle', class: 'second-level', color: '#9c27b0' },
        'resolved': { label: 'Resuelta', icon: 'check-circle', class: 'resolved', color: '#28a745' }
    };

    const typeConfig = {
        'danger': { label: 'Crítica', icon: 'exclamation-triangle-fill', color: '#dc3545' },
        'warning': { label: 'Advertencia', icon: 'exclamation-circle-fill', color: '#ffc107' },
        'low': { label: 'Baja Criticidad', icon: 'info-circle-fill', color: '#4fc3f7' },
        'success': { label: 'Éxito', icon: 'check-circle-fill', color: '#28a745' }
    };

    const alertsData = [
    { 
        id: 1, 
        type: 'danger', 
        title: 'Exceso de Velocidad', 
        message: 'Vehículo superó límite', 
        vehicle: 'ABC-123', 
        driver: 'Juan Pérez', 
        speed: 125, 
        speedLimit: 80, 
        lat: -23.6524, 
        lng: -70.3954, 
        address: 'Ruta 5 Norte, Antofagasta', 
        date: '2026-02-10', 
        hour: '14:32', 
        time: 'hace 5 min', 
        status: 'pending', 
        history: [],
        trajectory: [
            { lat: -23.7194, lng: -70.3987, timestamp: '14:17' },
            { lat: -23.7149, lng: -70.3981, timestamp: '14:18' },
            { lat: -23.7104, lng: -70.3975, timestamp: '14:19' },
            { lat: -23.7059, lng: -70.3969, timestamp: '14:20' },
            { lat: -23.7014, lng: -70.3963, timestamp: '14:21' },
            { lat: -23.6969, lng: -70.3957, timestamp: '14:22' },
            { lat: -23.6924, lng: -70.3951, timestamp: '14:23' },
            { lat: -23.6879, lng: -70.3945, timestamp: '14:24' },
            { lat: -23.6834, lng: -70.3939, timestamp: '14:25' },
            { lat: -23.6789, lng: -70.3933, timestamp: '14:26' },
            { lat: -23.6744, lng: -70.3927, timestamp: '14:27' },
            { lat: -23.6699, lng: -70.3921, timestamp: '14:28' },
            { lat: -23.6654, lng: -70.3915, timestamp: '14:29' },
            { lat: -23.6609, lng: -70.3909, timestamp: '14:30' },
            { lat: -23.6564, lng: -70.3903, timestamp: '14:31' }
        ]
    },
    { 
        id: 2, 
        type: 'warning', 
        title: 'Zona No Autorizada', 
        message: 'Ingreso a geocerca', 
        vehicle: 'XYZ-789', 
        driver: 'Carlos López', 
        speed: 45, 
        speedLimit: 60, 
        lat: -24.8854, 
        lng: -70.2598, 
        address: 'Calama, Región de Antofagasta', 
        date: '2026-02-10', 
        hour: '14:15', 
        time: 'hace 22 min', 
        status: 'in-progress', 
        history: [],
        trajectory: [
            { lat: -24.9524, lng: -70.2632, timestamp: '13:53' },
            { lat: -24.9479, lng: -70.2626, timestamp: '13:54' },
            { lat: -24.9434, lng: -70.2620, timestamp: '13:55' },
            { lat: -24.9389, lng: -70.2614, timestamp: '13:56' },
            { lat: -24.9344, lng: -70.2608, timestamp: '13:57' },
            { lat: -24.9299, lng: -70.2602, timestamp: '13:58' },
            { lat: -24.9254, lng: -70.2596, timestamp: '13:59' },
            { lat: -24.9209, lng: -70.2590, timestamp: '14:00' },
            { lat: -24.9164, lng: -70.2584, timestamp: '14:01' },
            { lat: -24.9119, lng: -70.2578, timestamp: '14:02' },
            { lat: -24.9074, lng: -70.2572, timestamp: '14:03' },
            { lat: -24.9029, lng: -70.2566, timestamp: '14:04' },
            { lat: -24.8984, lng: -70.2560, timestamp: '14:05' },
            { lat: -24.8939, lng: -70.2554, timestamp: '14:06' },
            { lat: -24.8894, lng: -70.2548, timestamp: '14:07' }
        ]
    },
    { 
        id: 3, 
        type: 'danger', 
        title: 'Botón de Pánico', 
        message: 'Emergencia activada', 
        vehicle: 'DEF-456', 
        driver: 'Ana Martínez', 
        speed: 0, 
        speedLimit: 80, 
        lat: -22.4549, 
        lng: -68.9235, 
        address: 'San Pedro de Atacama, Antofagasta', 
        date: '2026-02-10', 
        hour: '14:05', 
        time: 'hace 32 min', 
        status: 'second-level', 
        history: [],
        trajectory: [
            { lat: -22.5219, lng: -68.9269, timestamp: '13:33' },
            { lat: -22.5174, lng: -68.9263, timestamp: '13:34' },
            { lat: -22.5129, lng: -68.9257, timestamp: '13:35' },
            { lat: -22.5084, lng: -68.9251, timestamp: '13:36' },
            { lat: -22.5039, lng: -68.9245, timestamp: '13:37' },
            { lat: -22.4994, lng: -68.9239, timestamp: '13:38' },
            { lat: -22.4949, lng: -68.9233, timestamp: '13:39' },
            { lat: -22.4904, lng: -68.9227, timestamp: '13:40' },
            { lat: -22.4859, lng: -68.9221, timestamp: '13:41' },
            { lat: -22.4814, lng: -68.9215, timestamp: '13:42' },
            { lat: -22.4769, lng: -68.9209, timestamp: '13:43' },
            { lat: -22.4724, lng: -68.9203, timestamp: '13:44' },
            { lat: -22.4679, lng: -68.9197, timestamp: '13:45' },
            { lat: -22.4634, lng: -68.9191, timestamp: '13:46' },
            { lat: -22.4589, lng: -68.9185, timestamp: '13:47' }
        ]
    },
    { 
        id: 4, 
        type: 'low', 
        title: 'Mantenimiento', 
        message: 'Servicio en 500 km', 
        vehicle: 'GHI-321', 
        driver: 'Roberto Díaz', 
        speed: 65, 
        speedLimit: 80, 
        lat: -26.3412, 
        lng: -70.3324, 
        address: 'Chañaral, Región de Atacama', 
        date: '2026-02-10', 
        hour: '13:50', 
        time: 'hace 47 min', 
        status: 'pending', 
        history: [],
        trajectory: [
            { lat: -26.4082, lng: -70.3358, timestamp: '13:28' },
            { lat: -26.4037, lng: -70.3352, timestamp: '13:29' },
            { lat: -26.3992, lng: -70.3346, timestamp: '13:30' },
            { lat: -26.3947, lng: -70.3340, timestamp: '13:31' },
            { lat: -26.3902, lng: -70.3334, timestamp: '13:32' },
            { lat: -26.3857, lng: -70.3328, timestamp: '13:33' },
            { lat: -26.3812, lng: -70.3322, timestamp: '13:34' },
            { lat: -26.3767, lng: -70.3316, timestamp: '13:35' },
            { lat: -26.3722, lng: -70.3310, timestamp: '13:36' },
            { lat: -26.3677, lng: -70.3304, timestamp: '13:37' },
            { lat: -26.3632, lng: -70.3298, timestamp: '13:38' },
            { lat: -26.3587, lng: -70.3292, timestamp: '13:39' },
            { lat: -26.3542, lng: -70.3286, timestamp: '13:40' },
            { lat: -26.3497, lng: -70.3280, timestamp: '13:41' },
            { lat: -26.3452, lng: -70.3274, timestamp: '13:42' }
        ]
    },
    { 
        id: 5, 
        type: 'success', 
        title: 'Entrega Completada', 
        message: 'Paquete entregado', 
        vehicle: 'JKL-654', 
        driver: 'Laura Hernández', 
        speed: 0, 
        speedLimit: 60, 
        lat: -27.3668, 
        lng: -70.3323, 
        address: 'Copiapó, Región de Atacama', 
        date: '2026-02-10', 
        hour: '13:30', 
        time: 'hace 1 hora', 
        status: 'resolved', 
        history: [],
        trajectory: [
            { lat: -27.4338, lng: -70.3357, timestamp: '13:08' },
            { lat: -27.4293, lng: -70.3351, timestamp: '13:09' },
            { lat: -27.4248, lng: -70.3345, timestamp: '13:10' },
            { lat: -27.4203, lng: -70.3339, timestamp: '13:11' },
            { lat: -27.4158, lng: -70.3333, timestamp: '13:12' },
            { lat: -27.4113, lng: -70.3327, timestamp: '13:13' },
            { lat: -27.4068, lng: -70.3321, timestamp: '13:14' },
            { lat: -27.4023, lng: -70.3315, timestamp: '13:15' },
            { lat: -27.3978, lng: -70.3309, timestamp: '13:16' },
            { lat: -27.3933, lng: -70.3303, timestamp: '13:17' },
            { lat: -27.3888, lng: -70.3297, timestamp: '13:18' },
            { lat: -27.3843, lng: -70.3291, timestamp: '13:19' },
            { lat: -27.3798, lng: -70.3285, timestamp: '13:20' },
            { lat: -27.3753, lng: -70.3279, timestamp: '13:21' },
            { lat: -27.3708, lng: -70.3273, timestamp: '13:22' }
        ]
    },
    { 
        id: 6, 
        type: 'warning', 
        title: 'Combustible Bajo', 
        message: 'Nivel menor al 20%', 
        vehicle: 'MNO-987', 
        driver: 'Miguel Torres', 
        speed: 78, 
        speedLimit: 80, 
        lat: -29.9027, 
        lng: -71.2519, 
        address: 'La Serena, Región de Coquimbo', 
        date: '2026-02-10', 
        hour: '13:15', 
        time: 'hace 1 hora', 
        status: 'in-progress', 
        history: [],
        trajectory: [
            { lat: -29.9697, lng: -71.2553, timestamp: '12:53' },
            { lat: -29.9652, lng: -71.2547, timestamp: '12:54' },
            { lat: -29.9607, lng: -71.2541, timestamp: '12:55' },
            { lat: -29.9562, lng: -71.2535, timestamp: '12:56' },
            { lat: -29.9517, lng: -71.2529, timestamp: '12:57' },
            { lat: -29.9472, lng: -71.2523, timestamp: '12:58' },
            { lat: -29.9427, lng: -71.2517, timestamp: '12:59' },
            { lat: -29.9382, lng: -71.2511, timestamp: '13:00' },
            { lat: -29.9337, lng: -71.2505, timestamp: '13:01' },
            { lat: -29.9292, lng: -71.2499, timestamp: '13:02' },
            { lat: -29.9247, lng: -71.2493, timestamp: '13:03' },
            { lat: -29.9202, lng: -71.2487, timestamp: '13:04' },
            { lat: -29.9157, lng: -71.2481, timestamp: '13:05' },
            { lat: -29.9112, lng: -71.2475, timestamp: '13:06' },
            { lat: -29.9067, lng: -71.2469, timestamp: '13:07' }
        ]
    },
    { 
        id: 7, 
        type: 'danger', 
        title: 'Motor Encendido', 
        message: 'Sin movimiento 30 min', 
        vehicle: 'PQR-147', 
        driver: 'Fernando Ruiz', 
        speed: 0, 
        speedLimit: 60, 
        lat: -31.9038, 
        lng: -71.2452, 
        address: 'Viña del Mar, Región de Valparaíso', 
        date: '2026-02-10', 
        hour: '12:45', 
        time: 'hace 2 horas', 
        status: 'pending', 
        history: [],
        trajectory: [
            { lat: -31.9708, lng: -71.2486, timestamp: '12:23' },
            { lat: -31.9663, lng: -71.2480, timestamp: '12:24' },
            { lat: -31.9618, lng: -71.2474, timestamp: '12:25' },
            { lat: -31.9573, lng: -71.2468, timestamp: '12:26' },
            { lat: -31.9528, lng: -71.2462, timestamp: '12:27' },
            { lat: -31.9483, lng: -71.2456, timestamp: '12:28' },
            { lat: -31.9438, lng: -71.2450, timestamp: '12:29' },
            { lat: -31.9393, lng: -71.2444, timestamp: '12:30' },
            { lat: -31.9348, lng: -71.2438, timestamp: '12:31' },
            { lat: -31.9303, lng: -71.2432, timestamp: '12:32' },
            { lat: -31.9258, lng: -71.2426, timestamp: '12:33' },
            { lat: -31.9213, lng: -71.2420, timestamp: '12:34' },
            { lat: -31.9168, lng: -71.2414, timestamp: '12:35' },
            { lat: -31.9123, lng: -71.2408, timestamp: '12:36' },
            { lat: -31.9078, lng: -71.2402, timestamp: '12:37' }
        ]
    },
    { 
        id: 8, 
        type: 'low', 
        title: 'Llegada a Destino', 
        message: 'Punto de entrega', 
        vehicle: 'STU-258', 
        driver: 'Patricia Vega', 
        speed: 0, 
        speedLimit: 40, 
        lat: -33.0472, 
        lng: -71.6127, 
        address: 'Valparaíso Centro', 
        date: '2026-02-10', 
        hour: '12:30', 
        time: 'hace 2 horas', 
        status: 'resolved', 
        history: [],
        trajectory: [
            { lat: -33.1142, lng: -71.6161, timestamp: '12:08' },
            { lat: -33.1097, lng: -71.6155, timestamp: '12:09' },
            { lat: -33.1052, lng: -71.6149, timestamp: '12:10' },
            { lat: -33.1007, lng: -71.6143, timestamp: '12:11' },
            { lat: -33.0962, lng: -71.6137, timestamp: '12:12' },
            { lat: -33.0917, lng: -71.6131, timestamp: '12:13' },
            { lat: -33.0872, lng: -71.6125, timestamp: '12:14' },
            { lat: -33.0827, lng: -71.6119, timestamp: '12:15' },
            { lat: -33.0782, lng: -71.6113, timestamp: '12:16' },
            { lat: -33.0737, lng: -71.6107, timestamp: '12:17' },
            { lat: -33.0692, lng: -71.6101, timestamp: '12:18' },
            { lat: -33.0647, lng: -71.6095, timestamp: '12:19' },
            { lat: -33.0602, lng: -71.6089, timestamp: '12:20' },
            { lat: -33.0557, lng: -71.6083, timestamp: '12:21' },
            { lat: -33.0512, lng: -71.6077, timestamp: '12:22' }
        ]
    },
    { 
        id: 9, 
        type: 'warning', 
        title: 'Desvío de Ruta', 
        message: 'Fuera de ruta', 
        vehicle: 'VWX-369', 
        driver: 'Ricardo Mora', 
        speed: 55, 
        speedLimit: 60, 
        lat: -33.4489, 
        lng: -70.6693, 
        address: 'Santiago Centro, Región Metropolitana', 
        date: '2026-02-10', 
        hour: '12:15', 
        time: 'hace 2 horas', 
        status: 'in-progress', 
        history: [],
        trajectory: [
            { lat: -33.5159, lng: -70.6727, timestamp: '11:53' },
            { lat: -33.5114, lng: -70.6721, timestamp: '11:54' },
            { lat: -33.5069, lng: -70.6715, timestamp: '11:55' },
            { lat: -33.5024, lng: -70.6709, timestamp: '11:56' },
            { lat: -33.4979, lng: -70.6703, timestamp: '11:57' },
            { lat: -33.4934, lng: -70.6697, timestamp: '11:58' },
            { lat: -33.4889, lng: -70.6691, timestamp: '11:59' },
            { lat: -33.4844, lng: -70.6685, timestamp: '12:00' },
            { lat: -33.4799, lng: -70.6679, timestamp: '12:01' },
            { lat: -33.4754, lng: -70.6673, timestamp: '12:02' },
            { lat: -33.4709, lng: -70.6667, timestamp: '12:03' },
            { lat: -33.4664, lng: -70.6661, timestamp: '12:04' },
            { lat: -33.4619, lng: -70.6655, timestamp: '12:05' },
            { lat: -33.4574, lng: -70.6649, timestamp: '12:06' },
            { lat: -33.4529, lng: -70.6643, timestamp: '12:07' }
        ]
    },
    { 
        id: 10, 
        type: 'success', 
        title: 'Inicio de Jornada', 
        message: 'Jornada iniciada', 
        vehicle: 'YZA-741', 
        driver: 'Sandra Jiménez', 
        speed: 25, 
        speedLimit: 40, 
        lat: -33.3650, 
        lng: -70.5734, 
        address: 'Las Condes, Santiago', 
        date: '2026-02-10', 
        hour: '08:00', 
        time: 'hace 6 horas', 
        status: 'resolved', 
        history: [],
        trajectory: [
            { lat: -33.4320, lng: -70.5768, timestamp: '07:38' },
            { lat: -33.4275, lng: -70.5762, timestamp: '07:39' },
            { lat: -33.4230, lng: -70.5756, timestamp: '07:40' },
            { lat: -33.4185, lng: -70.5750, timestamp: '07:41' },
            { lat: -33.4140, lng: -70.5744, timestamp: '07:42' },
            { lat: -33.4095, lng: -70.5738, timestamp: '07:43' },
            { lat: -33.4050, lng: -70.5732, timestamp: '07:44' },
            { lat: -33.4005, lng: -70.5726, timestamp: '07:45' },
            { lat: -33.3960, lng: -70.5720, timestamp: '07:46' },
            { lat: -33.3915, lng: -70.5714, timestamp: '07:47' },
            { lat: -33.3870, lng: -70.5708, timestamp: '07:48' },
            { lat: -33.3825, lng: -70.5702, timestamp: '07:49' },
            { lat: -33.3780, lng: -70.5696, timestamp: '07:50' },
            { lat: -33.3735, lng: -70.5690, timestamp: '07:51' },
            { lat: -33.3690, lng: -70.5684, timestamp: '07:52' }
        ]
    },
    { 
        id: 11, 
        type: 'danger', 
        title: 'Frenado Brusco', 
        message: 'Frenado de emergencia', 
        vehicle: 'BCD-852', 
        driver: 'Eduardo Castro', 
        speed: 15, 
        speedLimit: 80, 
        lat: -33.5987, 
        lng: -70.5781, 
        address: 'Ruta 5 Sur, Puente Alto', 
        date: '2026-02-10', 
        hour: '11:45', 
        time: 'hace 3 horas', 
        status: 'pending', 
        history: [],
        trajectory: [
            { lat: -33.6657, lng: -70.5815, timestamp: '11:23' },
            { lat: -33.6612, lng: -70.5809, timestamp: '11:24' },
            { lat: -33.6567, lng: -70.5803, timestamp: '11:25' },
            { lat: -33.6522, lng: -70.5797, timestamp: '11:26' },
            { lat: -33.6477, lng: -70.5791, timestamp: '11:27' },
            { lat: -33.6432, lng: -70.5785, timestamp: '11:28' },
            { lat: -33.6387, lng: -70.5779, timestamp: '11:29' },
            { lat: -33.6342, lng: -70.5773, timestamp: '11:30' },
            { lat: -33.6297, lng: -70.5767, timestamp: '11:31' },
            { lat: -33.6252, lng: -70.5761, timestamp: '11:32' },
            { lat: -33.6207, lng: -70.5755, timestamp: '11:33' },
            { lat: -33.6162, lng: -70.5749, timestamp: '11:34' },
            { lat: -33.6117, lng: -70.5743, timestamp: '11:35' },
            { lat: -33.6072, lng: -70.5737, timestamp: '11:36' },
            { lat: -33.6027, lng: -70.5731, timestamp: '11:37' }
        ]
    },
    { 
        id: 12, 
        type: 'low', 
        title: 'Actualización GPS', 
        message: 'GPS actualizado', 
        vehicle: 'EFG-963', 
        driver: 'Gabriela Ríos', 
        speed: 45, 
        speedLimit: 60, 
        lat: -34.1704, 
        lng: -70.7407, 
        address: 'Rancagua, Región de O\'Higgins', 
        date: '2026-02-10', 
        hour: '11:30', 
        time: 'hace 3 horas', 
        status: 'resolved', 
        history: [],
        trajectory: [
            { lat: -34.2374, lng: -70.7441, timestamp: '11:08' },
            { lat: -34.2329, lng: -70.7435, timestamp: '11:09' },
            { lat: -34.2284, lng: -70.7429, timestamp: '11:10' },
            { lat: -34.2239, lng: -70.7423, timestamp: '11:11' },
            { lat: -34.2194, lng: -70.7417, timestamp: '11:12' },
            { lat: -34.2149, lng: -70.7411, timestamp: '11:13' },
            { lat: -34.2104, lng: -70.7405, timestamp: '11:14' },
            { lat: -34.2059, lng: -70.7399, timestamp: '11:15' },
            { lat: -34.2014, lng: -70.7393, timestamp: '11:16' },
            { lat: -34.1969, lng: -70.7387, timestamp: '11:17' },
            { lat: -34.1924, lng: -70.7381, timestamp: '11:18' },
            { lat: -34.1879, lng: -70.7375, timestamp: '11:19' },
            { lat: -34.1834, lng: -70.7369, timestamp: '11:20' },
            { lat: -34.1789, lng: -70.7363, timestamp: '11:21' },
            { lat: -34.1744, lng: -70.7357, timestamp: '11:22' }
        ]
    }
    ];

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        renderAlerts();
        updateAllCounts();
        initCharts();
    });

    // Renderizar alertas
    function renderAlerts() {
        const container = document.getElementById('alertContainer');
        container.innerHTML = alertsData.map((alert, index) => createAlertCard(alert, index)).join('');
    }

    // Crear tarjeta de alerta
    function createAlertCard(alert, index) {
        const status = statusConfig[alert.status];
        const type = typeConfig[alert.type];
        const isCritical = alert.type === 'danger';
        
        return `
            <div class="custom-alert custom-alert-${alert.type} has-status-${alert.status} fade-in-up" 
                 data-type="${alert.type}" 
                 data-status="${alert.status}" 
                 data-id="${alert.id}" 
                 style="animation-delay:${index * 0.03}s" 
                 onclick="openAlertDetail(${alert.id})">
                ${isCritical ? '<span class="priority-badge">URGENTE</span>' : ''}
                <div class="alert-icon"><i class="bi bi-${type.icon}"></i></div>
                <div class="alert-title">${alert.title}</div>
                <p class="alert-message">${alert.message}</p>
                <div class="alert-vehicle"><i class="bi bi-truck me-1"></i>${alert.vehicle}</div>
                <div class="alert-time"><i class="bi bi-clock me-1"></i>${alert.time}</div>
                <div class="alert-status-badge status-${status.class}">
                    <i class="bi bi-${status.icon}"></i> ${status.label}
                </div>
            </div>
        `;
    }

    // Actualizar contadores
    function updateAllCounts() {
        document.getElementById('criticalCount').textContent = alertsData.filter(a => a.type === 'danger').length;
        document.getElementById('warningCount').textContent = alertsData.filter(a => a.type === 'warning').length;
        document.getElementById('lowCount').textContent = alertsData.filter(a => a.type === 'low').length;
        document.getElementById('successCount').textContent = alertsData.filter(a => a.type === 'success').length;
        updateCharts();
    }

    // Inicializar gráficos
    function initCharts() {
    am5.ready(function() {
        // Gráfico de Tipos
        let root1 = am5.Root.new("chartTypes");
        root1.setThemes([am5themes_Animated.new(root1)]);
        chartTypes = root1.container.children.push(am5percent.PieChart.new(root1, { innerRadius: am5.percent(50) }));
        let series1 = chartTypes.series.push(am5percent.PieSeries.new(root1, { 
            valueField: "value", 
            categoryField: "category", 
            fillField: "color" 
        }));
        series1.slices.template.setAll({ strokeWidth: 2, stroke: am5.color(0xffffff) });
        series1.labels.template.setAll({ fontSize: 10, fill: am5.color(0x1e3a5f) });
        series1.ticks.template.setAll({ stroke: am5.color(0x1e3a5f) });

        // Gráfico de Estados
        let root2 = am5.Root.new("chartStatus");
        root2.setThemes([am5themes_Animated.new(root2)]);
        chartStatus = root2.container.children.push(am5percent.PieChart.new(root2, { innerRadius: am5.percent(50) }));
        let series2 = chartStatus.series.push(am5percent.PieSeries.new(root2, { 
            valueField: "value", 
            categoryField: "category", 
            fillField: "color" 
        }));
        series2.slices.template.setAll({ strokeWidth: 2, stroke: am5.color(0xffffff) });
        series2.labels.template.setAll({ fontSize: 10, fill: am5.color(0x1e3a5f) });
        series2.ticks.template.setAll({ stroke: am5.color(0x1e3a5f) });

        updateCharts();
    });
}
    function updateCharts() {
        if (chartTypes) {
            const typesData = [
                { category: "Críticas", value: alertsData.filter(a => a.type === 'danger').length, color: am5.color(0xdc3545) },
                { category: "Advertencias", value: alertsData.filter(a => a.type === 'warning').length, color: am5.color(0xffc107) },
                { category: "Baja Criticidad", value: alertsData.filter(a => a.type === 'low').length, color: am5.color(0x4fc3f7) },
                { category: "Éxito", value: alertsData.filter(a => a.type === 'success').length, color: am5.color(0x28a745) }
            ].filter(d => d.value > 0);
            chartTypes.series.getIndex(0).data.setAll(typesData);
        }

        if (chartStatus) {
            const statusData = [
                { category: "Pendiente", value: alertsData.filter(a => a.status === 'pending').length, color: am5.color(0x6c757d) },
                { category: "En Desarrollo", value: alertsData.filter(a => a.status === 'in-progress').length, color: am5.color(0x4fc3f7) },
                { category: "2do Nivel", value: alertsData.filter(a => a.status === 'second-level').length, color: am5.color(0x9c27b0) },
                { category: "Resuelta", value: alertsData.filter(a => a.status === 'resolved').length, color: am5.color(0x28a745) }
            ].filter(d => d.value > 0);
            chartStatus.series.getIndex(0).data.setAll(statusData);
        }
    }

function openAlertDetail(id) {
    const alert = alertsData.find(a => a.id === id);
    if (!alert) return;
    
    currentAlertData = alert;
    const type = typeConfig[alert.type];
    const status = statusConfig[alert.status];

    // Header
    document.getElementById('modalHeader').style.background = `linear-gradient(135deg, ${type.color} 0%, ${type.color}99 100%)`;
    document.getElementById('modalAlertTitle').innerHTML = `<i class="bi bi-${type.icon} me-2"></i>${alert.title}`;
    
    // Badges
    const typeBadge = document.getElementById('modalAlertBadge');
    typeBadge.textContent = type.label;
    typeBadge.style.background = type.color;
    typeBadge.style.color = 'white';

    const statusBadge = document.getElementById('modalAlertStatusBadge');
    statusBadge.textContent = status.label;
    statusBadge.style.background = status.color;
    statusBadge.style.color = 'white';

    // Detalles
    document.getElementById('detailAlertType').textContent = type.label;
    document.getElementById('detailVehicle').textContent = alert.vehicle;
    document.getElementById('detailDriver').textContent = alert.driver;
    document.getElementById('detailAddress').textContent = alert.address;
    document.getElementById('detailSpeed').textContent = `${alert.speed} / ${alert.speedLimit} km/h`;
    document.getElementById('detailDateTime').textContent = `${alert.date} ${alert.hour}`;

    // Velocidad
    document.getElementById('speedValue').textContent = `${alert.speed} km/h`;
    const speedClass = alert.speed > alert.speedLimit ? 'high' : alert.speed > alert.speedLimit * 0.8 ? 'medium' : 'low';
    document.getElementById('speedIndicator').className = `speed-indicator ${speedClass}`;

    updateStatusButtons(alert.status);
    updateTimeline(alert.history);

    const modal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
    modal.show();

    document.getElementById('alertDetailModal').addEventListener('shown.bs.modal', function() {
        // Limpiar animación anterior si existe
        if (animationInProgress) {
            stopAnimation();
        }
        
        initMap(alert);
        
        // Mostrar controles inmediatamente
        document.getElementById('animationControls').style.display = 'flex';
        updateControlButtons('stopped');
    }, { once: true });
    
    // Limpiar animación al cerrar modal
    document.getElementById('alertDetailModal').addEventListener('hidden.bs.modal', function() {
        stopAnimation();
    }, { once: true });
}

    function updateStatusButtons(current) {
        document.querySelectorAll('.status-selector-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.status-selector-btn.${current}-btn`);
        if (activeBtn) activeBtn.classList.add('active');
    }

    // Cambiar estado de alerta
    function changeAlertStatus(newStatus) {
        if (!currentAlertData) return;

        const oldStatus = currentAlertData.status;
        const status = statusConfig[newStatus];
        
        currentAlertData.status = newStatus;
        currentAlertData.history.unshift({
            user: 'Usuario',
            date: new Date().toLocaleTimeString().slice(0, 5),
            text: `Estado cambiado: ${statusConfig[oldStatus].label} → ${status.label}`,
            type: newStatus,
            badge: status.label
        });

        // Actualizar UI del modal
        updateStatusButtons(newStatus);
        updateTimeline(currentAlertData.history);

        const statusBadge = document.getElementById('modalAlertStatusBadge');
        statusBadge.textContent = status.label;
        statusBadge.style.background = status.color;

        // Actualizar tarjeta en el grid
        const card = document.querySelector(`[data-id="${currentAlertData.id}"]`);
        if (card) {
            card.className = `custom-alert custom-alert-${currentAlertData.type} has-status-${newStatus} fade-in-up`;
            card.dataset.status = newStatus;
            const badge = card.querySelector('.alert-status-badge');
            badge.className = `alert-status-badge status-${status.class}`;
            badge.innerHTML = `<i class="bi bi-${status.icon}"></i> ${status.label}`;
        }

        updateAllCounts();
        showToast(`Estado cambiado a: ${status.label}`, 'success');

        if (newStatus === 'resolved') {
            setTimeout(function() {
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('alertDetailModal'));
                if (modalInstance) modalInstance.hide();
            }, 800);
        }
    }
    function updateTimeline(history) {
        const timeline = document.getElementById('managementTimeline');
        
        if (!history || history.length === 0) {
            timeline.innerHTML = '<p class="text-center" style="color:#8899a6;">Sin gestiones registradas</p>';
            return;
        }
        timeline.innerHTML = history.map(function(h) {
            const statusColor = statusConfig[h.type] ? statusConfig[h.type].color : '#6c757d';
            return `
                <div class="timeline-item ${h.type}">
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="timeline-user">${h.user}</span>
                            <span class="timeline-date">${h.date}</span>
                        </div>
                        <p class="timeline-text mb-2">${h.text}</p>
                        <span class="badge" style="background:${statusColor};font-size:0.65rem;">${h.badge}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    function addManagement() {
        const type = document.getElementById('managementType').value;
        const desc = document.getElementById('managementDescription').value.trim();

        if (!desc) {
            showToast('Ingresa una descripción', 'warning');
            return;
        }

        const labels = {
            comment: 'Comentario',
            contact: 'Contacto',
            escalate: 'Escalada',
            resolve: 'Resuelta'
        };

        const types = {
            comment: 'pending',
            contact: 'in-progress',
            escalate: 'second-level',
            resolve: 'resolved'
        };

        currentAlertData.history.unshift({
            user: 'Usuario',
            date: new Date().toLocaleTimeString().slice(0, 5),
            text: desc,
            type: types[type],
            badge: labels[type]
        });

        if (type === 'escalate') {
            changeAlertStatus('second-level');
        } else if (type === 'resolve') {
            changeAlertStatus('resolved');
        } else {
            updateTimeline(currentAlertData.history);
        }
        document.getElementById('managementDescription').value = '';
        showToast('Gestión registrada', 'success');
    }
    function filterByType(type, btn) {
        document.querySelectorAll('.type-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.custom-alert').forEach(function(alert) {
            if (type === 'all' || alert.dataset.type === type) {
                alert.style.display = 'flex';
            } else {
                alert.style.display = 'none';
            }
        });
    }
    function filterByStatus(status, btn) {
        document.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.custom-alert').forEach(function(alert) {
            if (status === 'all' || alert.dataset.status === status) {
                alert.style.display = 'flex';
            } else {
                alert.style.display = 'none';
            }
        });
    }
    function addNewAlert() {
        const types = ['danger', 'warning', 'low', 'success'];
        const statuses = ['pending', 'in-progress', 'second-level'];
        const titles = {
            danger: ['Exceso de Velocidad', 'Botón de Pánico', 'Frenado Brusco', 'Colisión Detectada'],
            warning: ['Zona No Autorizada', 'Combustible Bajo', 'Desvío de Ruta', 'Batería Baja'],
            low: ['Mantenimiento', 'Llegada a Destino', 'Actualización GPS', 'Reporte Programado'],
            success: ['Entrega Completada', 'Inicio de Jornada', 'Check-in Realizado', 'Ruta Completada']
        };

        const type = types[Math.floor(Math.random() * types.length)];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const title = titles[type][Math.floor(Math.random() * titles[type].length)];

        const newAlert = {
            id: Date.now(),
            type: type,
            status: status,
            title: title,
            message: 'Alerta generada automáticamente',
            vehicle: `VEH-${Math.floor(Math.random() * 999).toString().padStart(3, '0')}`,
            driver: 'Conductor Asignado',
            speed: Math.floor(Math.random() * 120),
            speedLimit: 80,
            lat: 19.43 + (Math.random() * 0.1 - 0.05),
            lng: -99.13 + (Math.random() * 0.1 - 0.05),
            address: 'CDMX, México',
            time: 'Ahora',
            date: new Date().toLocaleDateString(),
            hour: new Date().toLocaleTimeString(),
            history: [{
                user: 'Sistema',
                date: new Date().toLocaleTimeString().slice(0, 5),
                text: 'Alerta creada automáticamente',
                type: 'pending',
                badge: 'Nueva'
            }]
        };

        alertsData.unshift(newAlert);
        renderAlerts();
        updateAllCounts();
        showToast('Nueva alerta agregada', 'info');
    }
    function clearAllAlerts() {
        if (!confirm('¿Estás seguro de eliminar todas las alertas?')) return;
        
        alertsData.length = 0;
        renderAlerts();
        updateAllCounts();
        showToast('Todas las alertas eliminadas', 'warning');
    }
    function refreshAlerts() {
        const container = document.getElementById('alertContainer');
        container.style.opacity = '0.5';
        
        setTimeout(function() {
            container.style.opacity = '1';
            showToast('Alertas actualizadas', 'success');
        }, 500);
    }
    function loadMoreAlerts() {
        for (let i = 0; i < 6; i++) {
            setTimeout(function() {
                addNewAlert();
            }, i * 100);
        }
    }
    function showToast(message, type) {
    const icons = {
        success: 'check-circle-fill',
        danger: 'exclamation-triangle-fill',
        warning: 'exclamation-circle-fill',
        info: 'info-circle-fill'
    };

    const colors = {
        success: '#28a745',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#4fc3f7'
    };

    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();

    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" style="background:white;border:2px solid ${colors[type]};border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.15);">
            <div class="toast-header" style="background:${colors[type]};color:${type === 'warning' ? '#212529' : 'white'};border-radius:10px 10px 0 0;">
                <i class="bi bi-${icons[type]} me-2"></i>
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close ${type === 'warning' ? '' : 'btn-close-white'}" onclick="this.closest('.toast').remove()"></button>
            </div>
            <div class="toast-body" style="color:#333;">
                ${message}
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', toastHTML);

    setTimeout(function() {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.style.transition = 'opacity 0.3s';
            toast.style.opacity = '0';
            setTimeout(function() {
                toast.remove();
            }, 300);
        }
    }, 3000);
}
let animationInProgress = false;
let animationPaused = false;
let animationMarker = null;
let animationFrameId = null;
let speedLabel = null;
let animationSpeed = 1;
let animationStartTime = 0;
let animationElapsedBeforePause = 0;
let finalMarkerInstance = null;





























function generateSpeedForTrajectory(alert) {
    return alert.trajectory.map((point, index) => {
        const variation = Math.random() * 20 - 10;
        let speed = alert.speedLimit + variation;
        const proximityFactor = index / alert.trajectory.length;
        speed = speed * (1 - proximityFactor) + alert.speed * proximityFactor;
        return Math.max(0, Math.round(speed));
    });
}
function createFinalMarker(alert) {
    const fullTrajectory = [...alert.trajectory, { lat: alert.lat, lng: alert.lng }];
    const finalPos = [fullTrajectory[fullTrajectory.length - 1].lng, fullTrajectory[fullTrajectory.length - 1].lat];
    
    console.log('Creando marker final en:', finalPos);
    
    const alertMarkerEl = document.createElement('div');
    alertMarkerEl.className = 'final-marker-wrapper';
    alertMarkerEl.innerHTML = `
        <div class="final-marker-pulse"></div>
        <div class="final-marker-circle">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
    `;
    
    finalMarkerInstance = new mapboxgl.Marker({ 
        element: alertMarkerEl, 
        anchor: 'center'
    })
    .setLngLat(finalPos)
    .addTo(map);
    
    console.log('Marker final creado');
}
function cleanupFinalMarker() {
    if (finalMarkerInstance) {
        finalMarkerInstance.remove();
        finalMarkerInstance = null;
    }
    document.querySelectorAll('.final-marker-wrapper').forEach(m => {
        if (m.parentElement) m.parentElement.remove();
    });
}
function cleanupForRestart() {
    console.log('Limpiando para reiniciar...');
    
    // Cancelar animación
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    
    // Remover markers de animación
    if (animationMarker) {
        animationMarker.remove();
        animationMarker = null;
    }
    
    if (speedLabel) {
        speedLabel.remove();
        speedLabel = null;
    }
    
    // Remover popups
    document.querySelectorAll('.mapboxgl-popup').forEach(p => p.remove());
    
    // Limpiar capas y sources si existen
    if (map && map.loaded()) {
        const layers = ['trajectory-line', 'trajectory-line-shadow', 'trajectory-points-inner', 'trajectory-points'];
        const sources = ['trajectory', 'trajectory-points'];
        
        layers.forEach(layer => {
            if (map.getLayer(layer)) {
                map.removeLayer(layer);
            }
        });
        
        sources.forEach(source => {
            if (map.getSource(source)) {
                map.removeSource(source);
            }
        });
    }
    
    console.log('Limpieza completada');
}

function initMap(alert) {
    if (map) {
        console.log('Mapa ya existe, centrando en nueva alerta');
        
        // Limpiar marker final anterior
        cleanupFinalMarker();
        
        // Limpiar animación
        cleanupForRestart();
        
        // Centrar en la nueva alerta
        const fullTrajectory = [...alert.trajectory, { lat: alert.lat, lng: alert.lng }];
        const bounds = new mapboxgl.LngLatBounds();
        fullTrajectory.forEach(point => bounds.extend([point.lng, point.lat]));
        map.fitBounds(bounds, { padding: 80, duration: 1000 });
        
        // Crear marker final para la nueva alerta
        setTimeout(() => {
            createFinalMarker(alert);
        }, 100);
        
        return;
    }
    
    console.log('Creando mapa');
    map = new mapboxgl.Map({
        container: 'alertMap',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [alert.lng, alert.lat],
        zoom: 10
    });

    map.addControl(new mapboxgl.NavigationControl());
    
    map.on('load', function() {
        console.log('Mapa cargado');
        const fullTrajectory = [...alert.trajectory, { lat: alert.lat, lng: alert.lng }];
        const bounds = new mapboxgl.LngLatBounds();
        fullTrajectory.forEach(point => bounds.extend([point.lng, point.lat]));
        map.fitBounds(bounds, { padding: 80, duration: 1000 });
        
        // Crear marker final al cargar el mapa
        setTimeout(() => {
            createFinalMarker(alert);
        }, 100);
    });
}


function animateTrajectory(alert) {
    if (!alert && currentAlertData) {
        alert = currentAlertData;
    }
    
    if (!alert) {
        return;
    }
    
    if (animationInProgress && !animationPaused) {
        console.log('Ya está animando');
        return;
    }
    
    if (animationPaused) {
        resumeAnimation();
        return;
    }
    
    if (!map || !map.loaded()) {
        setTimeout(() => animateTrajectory(alert), 300);
        return;
    }
    
    console.log('=== INICIANDO ANIMACIÓN ===');
    animationInProgress = true;
    animationPaused = false;
    animationElapsedBeforePause = 0;
    
    // Limpiar solo elementos de animación (no el marker final)
    cleanupForRestart();
    document.getElementById('animationControls').style.display = 'flex';
    updateControlButtons('playing');
    const fullTrajectory = [...alert.trajectory, { lat: alert.lat, lng: alert.lng }];
    const coordinates = fullTrajectory.map(point => [point.lng, point.lat]);
    const speeds = [...generateSpeedForTrajectory(alert), alert.speed];
    map.addSource('trajectory-points', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: coordinates.map((coord, idx) => ({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: coord },
                properties: { speed: speeds[idx], index: idx }
            }))
        }
    });
    
    map.addLayer({
        id: 'trajectory-points',
        type: 'circle',
        source: 'trajectory-points',
        paint: { 'circle-radius': 3, 'circle-color': '#fff', 'circle-opacity': 0.9 }
    });
    
    map.addLayer({
        id: 'trajectory-points-inner',
        type: 'circle',
        source: 'trajectory-points',
        paint: { 'circle-radius': 2, 'circle-color': '#4fc3f7', 'circle-opacity': 1 }
    });
    
    map.addSource('trajectory', {
        type: 'geojson',
        data: { type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: [] } }
    });
    
    map.addLayer({
        id: 'trajectory-line-shadow',
        type: 'line',
        source: 'trajectory',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 'line-color': '#000', 'line-width': 8, 'line-opacity': 0.2, 'line-blur': 4 }
    });
    
    map.addLayer({
        id: 'trajectory-line',
        type: 'line',
        source: 'trajectory',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 'line-color': '#4fc3f7', 'line-width': 6, 'line-opacity': 0.9 }
    });
    
    // Crear markers de animación (estos desaparecerán al final)
    const markerEl = document.createElement('div');
    markerEl.innerHTML = `
        <div style="position: relative;">
            <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #4fc3f7; border: 3px solid white; box-shadow: 0 0 20px rgba(79, 195, 247, 0.6), 0 2px 10px rgba(0, 0, 0, 0.3); position: relative; z-index: 2;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 32px; height: 32px; border-radius: 50%; background-color: rgba(79, 195, 247, 0.3); animation: ripple 1.5s ease-out infinite; z-index: 1;"></div>
        </div>
    `;
    
    animationMarker = new mapboxgl.Marker({ element: markerEl, anchor: 'center' })
        .setLngLat(coordinates[0])
        .addTo(map);
    
    const speedEl = document.createElement('div');
    speedEl.style.cssText = 'background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); border: 2px solid #4fc3f7; white-space: nowrap; display: flex; align-items: center; gap: 6px;';
    speedEl.innerHTML = `<i class="bi bi-speedometer2"></i><span id="speedValueAnim">${speeds[0]} km/h</span>`;
    
    speedLabel = new mapboxgl.Marker({ element: speedEl, anchor: 'bottom', offset: [0, -35] })
        .setLngLat(coordinates[0])
        .addTo(map);
    
    // Iniciar animación
    startAnimation(alert, coordinates, speeds, markerEl, speedEl);
}
function startAnimation(alert, coordinates, speeds, markerEl, speedEl) {
    animationStartTime = Date.now();
    const baseDuration = 6000;
    
    function animate() {
        if (animationPaused) return;
        
        const elapsed = (Date.now() - animationStartTime) * animationSpeed + animationElapsedBeforePause;
        const progress = Math.min(elapsed / baseDuration, 1);
        const eased = progress < 0.5 ? 4 * progress * progress * progress : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;
        
        const totalPoints = coordinates.length - 1;
        const currentFloat = eased * totalPoints;
        const idx = Math.floor(currentFloat);
        const frac = currentFloat - idx;
        
        if (idx < totalPoints) {
            const lng = coordinates[idx][0] + (coordinates[idx + 1][0] - coordinates[idx][0]) * frac;
            const lat = coordinates[idx][1] + (coordinates[idx + 1][1] - coordinates[idx][1]) * frac;
            const currentPos = [lng, lat];
            const currentSpeed = Math.round(speeds[idx] + (speeds[idx + 1] - speeds[idx]) * frac);
            
            const drawn = coordinates.slice(0, idx + 1);
            if (frac > 0) drawn.push(currentPos);
            
            map.getSource('trajectory').setData({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: drawn }
            });
            
            animationMarker.setLngLat(currentPos);
            speedLabel.setLngLat(currentPos);
            
            const speedColor = currentSpeed > alert.speedLimit ? '#dc3545' : currentSpeed > alert.speedLimit * 0.8 ? '#ffc107' : '#28a745';
            const speedVal = speedEl.querySelector('#speedValueAnim');
            if (speedVal) {
                speedVal.textContent = `${currentSpeed} km/h`;
                speedEl.style.borderColor = speedColor;
            }
            
            animationFrameId = requestAnimationFrame(animate);
        } else {
            finishAnimation(alert, coordinates, speeds);
        }
    }
    
    animate();
}
function startAnimation(alert, coordinates, speeds, markerEl, speedEl) {
    animationStartTime = Date.now();
    const baseDuration = 6000;
    
    function animate() {
        if (animationPaused) return;
        
        const elapsed = (Date.now() - animationStartTime) * animationSpeed + animationElapsedBeforePause;
        const progress = Math.min(elapsed / baseDuration, 1);
        const eased = progress < 0.5 ? 4 * progress * progress * progress : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;
        
        const totalPoints = coordinates.length - 1;
        const currentFloat = eased * totalPoints;
        const idx = Math.floor(currentFloat);
        const frac = currentFloat - idx;
        
        if (idx < totalPoints) {
            const lng = coordinates[idx][0] + (coordinates[idx + 1][0] - coordinates[idx][0]) * frac;
            const lat = coordinates[idx][1] + (coordinates[idx + 1][1] - coordinates[idx][1]) * frac;
            const currentPos = [lng, lat];
            const currentSpeed = Math.round(speeds[idx] + (speeds[idx + 1] - speeds[idx]) * frac);
            
            // Actualizar línea
            const drawn = coordinates.slice(0, idx + 1);
            if (frac > 0) drawn.push(currentPos);
            map.getSource('trajectory').setData({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: drawn }
            });
            
            // Actualizar markers
            animationMarker.setLngLat(currentPos);
            speedLabel.setLngLat(currentPos);
            
            // Actualizar velocidad
            const speedColor = currentSpeed > alert.speedLimit ? '#dc3545' : currentSpeed > alert.speedLimit * 0.8 ? '#ffc107' : '#28a745';
            const speedVal = speedEl.querySelector('#speedValueAnim');
            if (speedVal) {
                speedVal.textContent = `${currentSpeed} km/h`;
                speedEl.style.borderColor = speedColor;
            }
            
            animationFrameId = requestAnimationFrame(animate);
        } else {
            finishAnimation(alert, coordinates, speeds);
        }
    }
    
    animate();
}

function finishAnimation(alert, coordinates, speeds) {
    map.getSource('trajectory').setData({
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: coordinates }
    });
    
    const finalPos = coordinates[coordinates.length - 1];
    
    // Fade out markers de animación
    if (animationMarker) {
        const el = animationMarker.getElement();
        el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
        el.style.opacity = '0';
        el.style.transform = 'scale(0.5)';
        setTimeout(() => { 
            if (animationMarker) {
                animationMarker.remove(); 
                animationMarker = null;
            }
        }, 500);
    }
    
    if (speedLabel) {
        const el = speedLabel.getElement();
        el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-20px)';
        setTimeout(() => { 
            if (speedLabel) {
                speedLabel.remove(); 
                speedLabel = null;
            }
        }, 500);
    }
    
    // Mostrar popup (el marker de alerta ya está visible)
    setTimeout(() => {
        const speedColor = alert.speed > alert.speedLimit ? '#dc3545' : alert.speed > alert.speedLimit * 0.8 ? '#ffc107' : '#28a745';
        new mapboxgl.Popup({ 
            offset: [15, 0], 
            closeButton: false, 
            anchor: 'left', 
            maxWidth: 'none' 
        })
        .setLngLat(finalPos)
        .setHTML(`
            <div class="uber-popup popup-bounce-in">
                <div class="uber-popup-compact">
                    <div class="popup-speed" style="color: ${speedColor};">
                        <i class="bi bi-speedometer2"></i>
                        <span>${alert.speed} km/h</span>
                    </div>
                    <div class="popup-time">
                        <i class="bi bi-clock"></i>
                        <span>${alert.hour}</span>
                    </div>
                </div>
            </div>
        `)
        .addTo(map);
    }, 600);
    
    animationInProgress = false;
    updateControlButtons('stopped');
    console.log('Animación finalizada');
}
function pauseAnimation() {
    if (!animationInProgress || animationPaused) return;
    animationPaused = true;
    animationElapsedBeforePause += (Date.now() - animationStartTime) * animationSpeed;
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    updateControlButtons('paused');
}

// Función para reanudar la animación
function resumeAnimation() {
    if (!animationInProgress || !animationPaused) return;
    animationPaused = false;
    animationStartTime = Date.now();
    updateControlButtons('playing');
    
    if (currentAlertData) {
        const alert = currentAlertData;
        const fullTrajectory = [...alert.trajectory, { lat: alert.lat, lng: alert.lng }];
        const coordinates = fullTrajectory.map(point => [point.lng, point.lat]);
        const speeds = [...generateSpeedForTrajectory(alert), alert.speed];
        const markerEl = animationMarker ? animationMarker.getElement() : null;
        const speedEl = speedLabel ? speedLabel.getElement() : null;
        
        if (markerEl && speedEl) {
            startAnimation(alert, coordinates, speeds, markerEl, speedEl);
        }
    }
}


// Función auxiliar para reanudar el step
function animateStepResume(alert, coordinates, speeds) {
    const baseDuration = 6000;
    
    function easeInOutCubic(t) {
        return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
    }
    
    function interpolate(coord1, coord2, fraction) {
        return [
            coord1[0] + (coord2[0] - coord1[0]) * fraction,
            coord1[1] + (coord2[1] - coord1[1]) * fraction
        ];
    }
    
    function interpolateSpeed(speed1, speed2, fraction) {
        return Math.round(speed1 + (speed2 - speed1) * fraction);
    }
    
    function getSpeedColor(speed, limit) {
        if (speed > limit) return '#dc3545';
        if (speed > limit * 0.8) return '#ffc107';
        return '#28a745';
    }
    
    function step() {
        if (animationPaused) return;
        
        const currentTime = Date.now();
        const elapsed = (currentTime - animationStartTime) * animationSpeed + animationElapsedBeforePause;
        const progress = Math.min(elapsed / baseDuration, 1);
        const easedProgress = easeInOutCubic(progress);
        
        const totalPoints = coordinates.length - 1;
        const currentFloat = easedProgress * totalPoints;
        const currentIndex = Math.floor(currentFloat);
        const fraction = currentFloat - currentIndex;
        
        if (currentIndex < totalPoints) {
            const currentPosition = interpolate(
                coordinates[currentIndex],
                coordinates[currentIndex + 1],
                fraction
            );
            
            const currentSpeed = interpolateSpeed(
                speeds[currentIndex],
                speeds[currentIndex + 1],
                fraction
            );
            
            const drawnCoordinates = coordinates.slice(0, currentIndex + 1);
            if (fraction > 0) {
                drawnCoordinates.push(currentPosition);
            }
            
            map.getSource('trajectory').setData({
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': drawnCoordinates
                }
            });
            
            animationMarker.setLngLat(currentPosition);
            speedLabel.setLngLat(currentPosition);
            
            const speedColor = getSpeedColor(currentSpeed, alert.speedLimit);
            const speedValueElement = document.querySelector('#speedValue');
            if (speedValueElement) {
                speedValueElement.textContent = `${currentSpeed} km/h`;
                speedLabel.getElement().style.borderColor = speedColor;
            }
            
            animationFrameId = requestAnimationFrame(step);
        } else {
            map.getSource('trajectory').setData({
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coordinates
                }
            });
            
            animationMarker.setLngLat([alert.lng, alert.lat]);
            speedLabel.setLngLat([alert.lng, alert.lat]);
            
            animationInProgress = false;
            updateControlButtons('stopped');
        }
    }
    
    step();
}
function stopAnimation() {
    console.log('Stop');
    animationInProgress = false;
    animationPaused = false;
    animationElapsedBeforePause = 0;
    cleanupForRestart(); // Solo limpia elementos de animación
    updateControlButtons('stopped');
}
function restartAnimation() {
    console.log('Restart');
    animationInProgress = false;
    animationPaused = false;
    animationElapsedBeforePause = 0;
    
    if (!currentAlertData || !map || !map.loaded()) {
        console.error('No se puede reiniciar');
        return;
    }
    
    cleanupForRestart();
    
    setTimeout(() => {
        animateTrajectory(currentAlertData);
    }, 200);
}
function setAnimationSpeed(speed) {
    const wasPlaying = animationInProgress && !animationPaused;
    if (wasPlaying) {
        animationElapsedBeforePause += (Date.now() - animationStartTime) * animationSpeed;
    }
    animationSpeed = speed;
    if (wasPlaying) {
        animationStartTime = Date.now();
    }
    document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-speed="${speed}"]`).classList.add('active');
}

function updateControlButtons(state) {
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    if (state === 'playing') {
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-flex';
    } else {
        playBtn.style.display = 'inline-flex';
        pauseBtn.style.display = 'none';
    }
}

function cleanupAnimationElements() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    if (animationMarker) {
        try {
            animationMarker.remove();
        } catch(e) {
            console.error('Error removiendo animationMarker:', e);
        }
        animationMarker = null;
    }
    
    if (speedLabel) {
        try {
            speedLabel.remove();
        } catch(e) {
            console.error('Error removiendo speedLabel:', e);
        }
        speedLabel = null;
    }
    
    // Remover popups
    document.querySelectorAll('.mapboxgl-popup').forEach(p => {
        try {
            p.remove();
        } catch(e) {}
    });
    
    // Remover markers finales
    document.querySelectorAll('.final-alert-marker').forEach(m => {
        try {
            if (m.parentElement) m.parentElement.remove();
        } catch(e) {}
    });
    
    // Verificar que el mapa existe y está listo ANTES de limpiar capas
    if (!map) {
        console.error('El mapa no existe!');
        return;
    }
    
    if (!map.loaded()) {
        console.warn('El mapa no está cargado');
        return;
    }
    try {
        const style = map.getStyle();
        if (!style) {
            console.error('El mapa no tiene estilo');
            return;
        }
    } catch(e) {
        console.error('Error al obtener estilo del mapa:', e);
        return;
    }

    const layers = ['trajectory-line', 'trajectory-line-shadow', 'trajectory-points-inner', 'trajectory-points'];
    
    layers.forEach(layer => {
        try {
            if (map.getLayer(layer)) {
                map.removeLayer(layer);
                console.log('Capa removida:', layer);
            }
        } catch(e) {
            console.error('Error removiendo capa', layer, e);
        }
    });
    const sources = ['trajectory', 'trajectory-points'];
    
    sources.forEach(source => {
        try {
            if (map.getSource(source)) {
                map.removeSource(source);
                console.log('Source removido:', source);
            }
        } catch(e) {
            console.error('Error removiendo source', source, e);
        }
    });
}


</script>
</body>
</html>